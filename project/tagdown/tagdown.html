<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/blog-web/images/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/katex.min.css"><title>TagDown | Blog</title><meta name="description" content="A blog and knowledge management system about web.">
    <link rel="modulepreload" href="/blog-web/assets/app.43fe0c63.js"><link rel="modulepreload" href="/blog-web/assets/tagdown.html.3869653d.js"><link rel="modulepreload" href="/blog-web/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/blog-web/assets/tagdown.html.dc2fd384.js">
    <link rel="stylesheet" href="/blog-web/assets/style.b42fd117.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="min-h-screen flex flex-col"><nav class="px-4 sm:px-8 py-2 flex justify-between items-center sticky top-0 z-30 bg-white"><div class="left flex items-center space-x-0.5"><!--[--><button class="text-gray-400 hover:bg-gray-100 catelog-btn p-2 select-none text-sm font-bold hover:text-gray-900 rounded-md lg:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path></svg></button><!--]--><a class="avatar p-2 hover:bg-gray-100 rounded-md" href="/blog-web/#"><img src="/blog-web/images/avatar.png" alt="avatar" class="w-10 h-10 rounded-full"></a></div><div class="right hidden sm:flex items-center space-x-0.5"><!--[--><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">All</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Network</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Frontend</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Backend</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Project</button><!--]--><!--[--><button class="text-gray-900 bg-gray-100 hover:bg-gray-200 p-2 select-none text-sm font-bold hover:text-gray-900 rounded-md hidden lg:block"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path></svg></button><!--]--></div><div class="more-container sm:hidden relative"><button style="" class="p-2 select-none hover:bg-gray-100 rounded-md text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"></path></svg></button><button style="display:none;" class="p-2 select-none hover:bg-gray-100 rounded-md text-red-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"></path></svg></button><div style="display:none;" class="more-modal p-2 absolute top-10 right-0 z-10 flex flex-col space-y-2 bg-gray-100 rounded-md opacity-90"><!--[--><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">All</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Network</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Frontend</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Backend</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Project</button><!--]--></div></div></nav><div class="relative flex-grow"><div class="theme-container no-navbar no-sidebar"><!--[--><!----><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="tagdown" tabindex="-1"><a class="header-anchor" href="#tagdown" aria-hidden="true">#</a> TagDown</h1><p><img src="/blog-web/assets/tagdown.a61dbc1c.png" alt="tagdown"></p><p>TagDown 是一款开源的书签管理插件， 您可以使用扩展程序<em>浏览</em>、<em>新增</em>、<em>修改</em>书签，它也支持以不同方式<em>导出</em>书签。</p><p>除了常见的书签管理功能，还具有以下特点：</p><ul><li><p>支持 🎬 <a href="https://www.bilibili.com/video/BV1up4y1s7VP?p=4" target="_blank" rel="noopener noreferrer">新增</a>书签，并附加额外的信息，例如 <code>tags</code>、<code>groups</code> 等</p></li><li><p>支持 🎬 <a href="https://www.bilibili.com/video/BV1up4y1s7VP?p=7" target="_blank" rel="noopener noreferrer">导出</a>任意书签为 <code>json</code> 文档</p></li><li><p>以 🎬 <a href="https://www.bilibili.com/video/BV1up4y1s7VP?p=3" target="_blank" rel="noopener noreferrer">树图</a>的形式浏览层级结构的书签数据</p></li><li><p>一键打开多个书签，支持在 🎬 <a href="https://www.bilibili.com/video/BV1up4y1s7VP" target="_blank" rel="noopener noreferrer">标签组</a>内打开书签</p></li></ul><p>本文主要记录了我在开发 TagDown 扩展程序过程中的一些小收获。</p><h2 id="设计" tabindex="-1"><a class="header-anchor" href="#设计" aria-hidden="true">#</a> 设计</h2><p>该扩展程序与用户的交互界面主要是通过一个<strong>弹出窗 popup</strong>，当用户点击工具栏上扩展程序的图标时，会弹出一个 HTML 页面，该页面实现了大部分扩展程序的功能。</p><p>该页面有两种状态：</p><ul><li>浏览状态 browser：用户可以浏览 Chrome 中已存的所有书签</li><li>编辑状态 edit：用户在编辑页面可以新增、修改、删除书签</li></ul><p><img src="/blog-web/assets/tagdown-ui.892e9f23.png" alt="UI"></p><p>扩展程序在后台会监控标签切换激活状态，以分析当前访问的 URL 是否已收藏为书签，动态切换工具栏上扩展程序的图标状态。</p><p>扩展程序还提供一个配置页面 option page，可以对 IndexedDB 数据库执行导出、导入、删除操作，还可以按需导出书签。</p><p><img src="/blog-web/assets/tagdown-options-page.d41d00b4.png" alt="option page"></p><p>更详细的设计稿可以查看<a href="https://www.figma.com/community/file/1014891055524312843" target="_blank" rel="noopener noreferrer">这里</a>，还有一个<a href="https://www.figma.com/proto/2Rtmm9uWs4LOAqLviyvveX/TagDown?node-id=1447%3A7484&amp;scaling=scale-down&amp;page-id=1403%3A1050&amp;starting-point-node-id=1447%3A7484&amp;show-proto-sidebar=1" target="_blank" rel="noopener noreferrer">原型</a>可以体验扩展程序的基本交互。</p><h2 id="预备技能" tabindex="-1"><a class="header-anchor" href="#预备技能" aria-hidden="true">#</a> 预备技能</h2><p>本项目使用 Vue（Vue 3.0 版本）和 Chrome 所提供的 API 进行开发（当然还使用了必不可少的前端三大基本技能 HTML、CSS、JavaScript），此外 CSS 主要使用 Tailwindcss 框架。</p><ul><li>HTML</li><li>CSS、<a href="https://tailwindcss.com/" target="_blank" rel="noopener noreferrer">Tailwind CSS</a></li><li><a href="https://v3.cn.vuejs.org/" target="_blank" rel="noopener noreferrer">Vue</a>、JavaScript</li><li><a href="https://developer.chrome.com/docs/extensions/reference/" target="_blank" rel="noopener noreferrer">Chrome APIs</a></li></ul><h2 id="搭建开发环境" tabindex="-1"><a class="header-anchor" href="#搭建开发环境" aria-hidden="true">#</a> 搭建开发环境</h2><p>搭建一个使用 Vue+Vite+Tailwindcss 的开发环境，其中开发的扩展程序属于 Manifest V3 版本。</p><p>💡 系统已经安装 node 环境</p><p>💡 如果在开发中使用 VS Code 文本编辑器，推荐安装 Vue3 开发的配套 <a href="https://marketplace.visualstudio.com/items?itemName=johnsoncodehk.volar" target="_blank" rel="noopener noreferrer">Volar</a> 插件。</p><p>在终端输入以下命令<a href="https://cn.vitejs.dev/guide/#scaffolding-your-first-vite-project" target="_blank" rel="noopener noreferrer">创建一个 Vue3+Vite 的项目模板</a></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> init vite@latest
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>然后根据提示安装依赖包</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 将终端的路径切换到项目文件夹中</span>
<span class="token builtin class-name">cd</span> project-folder
<span class="token comment"># 安装依赖包</span>
<span class="token function">npm</span> <span class="token function">install</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>为了在项目中使用 ESLint 进行代码规范管理，需要安装 <a href="https://eslint.vuejs.org/" target="_blank" rel="noopener noreferrer">eslint-plugin-vue</a> 模块</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev eslint eslint-plugin-vue
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>然后在终端输入 <code>eslint --init</code> 命令进行初始化配置，根据自己的编程习惯和团队要求，按照提示设置代码样式规范：</p><ul><li><p><code>To check syntax, find problems, and enforece code style</code></p></li><li><p><code>JavaScript modules (import/export)</code></p></li><li><p><code>Vue.js</code></p></li><li><p><code>Browser</code> &amp; <code>Node</code></p></li><li><p><code>Use a popular style guide</code> -&gt; <code>Airbnb</code></p></li><li><p><code>JavaScript</code></p></li></ul><p>然后系统会安装所依赖的包和生成 ESLint 配置文件 <code>.eslintrc.js</code></p><p>由于在项目中使用的是 Vue3 版本，所以需要打开配置文件 <code>.eslintrc.js</code> 进行相应的修改</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&#39;plugin:vue/vue3-recommended&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;airbnb-base&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果使用 VS Code 进行代码编写，需要在 📁 文件夹 <code>.vscode</code> 中创建一个文件 <code>settings.json</code> 进行编辑器的 eslint 配置</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;editor.codeActionsOnSave&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;source.fixAll.eslint&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;eslint.validate&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;javascript&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;vue&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>💡 更多关于使用 ESLint 进行代码规范管理的细节可以参考该 🎬 <a href="https://www.bilibili.com/video/BV1pq4y1T75p" target="_blank" rel="noopener noreferrer">影片</a></p><p>由于开发 Chrome 插件需要特殊的项目结构，例如根目录需要有一个 <code>manifest.json</code> 文档以描述扩展程序相关信息和权限，还需要在终端输入以下命令安装一个特殊的插件 <a href="https://github.com/yeqisong/vite-plugin-vue-crx3" target="_blank" rel="noopener noreferrer">vite-plugin-vue-crx3</a></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> i -D vite-plugin-vue-crx3
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>根据该插件的<a href="https://github.com/yeqisong/vite-plugin-vue-crx3#2%E4%B8%80%E8%88%AC%E5%BC%80%E5%8F%91%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">说明文档</a>，修改项目的目录结构，以符合扩展程序开发要求。</p><blockquote><p>本插件的核心就是：就以 manifest.json 作为入口文件，自动分析 manifest 中的开发配置，获取 vue 应用的各个入口文件，打包时自动将 manifest.json 中开发路径更新为生产路径。</p></blockquote><p>项目原来的目录结构</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>│  .eslintrc.js
│  .gitignore
│  index.html
│  package-lock.json      
│  package.json
│  README.md
│  vite.config.js
│
├─.vscode
│      extensions.json
│      settings.json
│
├─public
│      favicon.ico
│
└─src
    │  App.vue
    │  main.js
    │
    ├─assets
    │      logo.png
    │
    └─components
            HelloWorld.vue
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>由于项目打包的入口文件是 <code>manifest.json</code>，所以删除原来的入口文件 <code>src/main.js</code> 以及相应相应的文件 <code>index.html</code>。然后新增 <code>src/manifest.json</code> 文档和其他文件。修改后的目录结构</p><p>💡 参考 <a href="https://github.com/yeqisong/crx3-dev-template" target="_blank" rel="noopener noreferrer">crx3-dev-template</a> 模板</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>│  .eslintrc.js       
│  .gitignore
│  package-lock.json  
│  package.json       
│  postcss.config.js  
│  README.md
│  tailwind.config.js 
│  vite.config.js     
│  
├─.vscode
│      extensions.json
│      settings.json  
│      
├─public
│  │  favicon.ico     
│  │  
│  └─_locales
│      └─en
└─src
    │  manifest.json  
    │  options.html   
    │  popup.html     
    │  
    ├─assets
    │  │  logo.png    
    │  │  
    │  └─images       
    │          icon128.png
    │          icon16.png 
    │          icon24.png 
    │          icon32.png 
    │          icon48.png 
    │          icon64.png 
    │          icon72.png 
    │          logo.png   
    │
    ├─background
    │      main.js        
    │      
    ├─options
    │      App.vue        
    │      main.js        
    │      
    └─popup
            App.vue       
            main.js  
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>主要的文件和文件夹作用：</p><ul><li><code>src/manifest.json</code> 扩展程序的配置清单</li><li><code>background</code> 与扩展程序的后台 service worker 相关的代码，在 manifest V3 版本的扩展程序中，后台没有可视的前端页面，所以该不会不需要使用 Vue</li><li><code>src/popup.html</code> 弹出窗的入口文件，📁 文件夹 <code>popup</code> 放置弹窗页面的相关代码文档，这是一个独立的 Vue 单页面应用</li><li><code>src/options.html</code> 设置页面的入口文件，📁 文件夹 <code>options</code> 放置设置页面的相关代码文档，这是一个独立的 Vue 单页面应用</li><li>📁 文件夹 <code>public/_locales</code> 放置与国际化（翻译）相关的文档</li></ul><p>其中在 📁 文件夹 <code>src</code> 中的 <code>manifest.json</code> 文档是扩展程序的配置清单</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TagDown&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;manifest_version&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TagDown is a bookmark manager.&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;service_worker&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./background/main.js&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;default_title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TagDown&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;default_popup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./popup.html&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;default_icon&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon16.png&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;32&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon32.png&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon48.png&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;64&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon64.png&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon128.png&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;options_page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./options.html&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon16.png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;32&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon32.png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon48.png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;64&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon64.png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./assets/images/icon128.png&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;default_locale&quot;</span><span class="token operator">:</span> <span class="token string">&quot;en&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>💡 由于放在 📁 文件夹 <code>src</code> 下的 <code>manifest.json</code> 只服务于开发环境，因此在设置资源（各个入口文件）的路径时，使用相对路径即可，插件打包时会自动分析并更新路径。</p><p>还要在 vite 配置文件 <code>vite.config.js</code> 引用插件，并设置入口文件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vite&#39;</span>
<span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">&#39;@vitejs/plugin-vue&#39;</span>
<span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">&#39;@vitejs/plugin-vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> crx3 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vite-plugin-vue-crx3&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// https://vitejs.dev/config/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&#39;@&#39;</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;src&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">crx3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// crx3即为插件入口函数</span>
  build<span class="token operator">:</span> <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token string">&#39;es2015&#39;</span><span class="token punctuation">,</span>
    rollupOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      input<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;src/manifest.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 将 src 中的 manifest.json 作为入口文件</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>该插件支持<strong>热重载</strong>便于开发调试，需要在 <code>package.json</code> 文档中添加相应的指令</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite preview&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite build --watch&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>然后在开发时使用 <code>npm run watch</code> 命令即可启用热重载功能，当代码的修改保存后，浏览器自动更新当前开发的插件，正在调用的网页也会自动刷新。</p><p>最后为了便于网页的样式设置，使用 <a href="https://tailwindcss.com/docs/guides/vue-3-vite" target="_blank" rel="noopener noreferrer">Tailwindcss 框架</a>，按照官方文档的依此执行以下步骤：</p><ul><li><p>在终端使用以下命令安装 Tailwind CSS 模块和相应的依赖包</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> -D tailwindcss@latest postcss@latest autoprefixer@latest
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>在终端使用以下命令初始化 Tailwind CSS 生成一个配置文件 <code>tailwind.config.js</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>npx tailwindcss init -p
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>为了优化项目<a href="https://tailwindcss.com/docs/just-in-time-mode#enabling-jit-mode" target="_blank" rel="noopener noreferrer">开发</a>和<a href="https://tailwindcss.com/docs/optimizing-for-production" target="_blank" rel="noopener noreferrer">打包</a>时的文件大小，需要在配置文件 <code>tailwind.config.js</code> 中进行设置，以删除未使用的样式代码</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  mode<span class="token operator">:</span> <span class="token string">&#39;jit&#39;</span><span class="token punctuation">,</span>
  purge<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;./src/**/*.{vue,js,ts,jsx,tsx}&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul><p>💡 vite 会通过<a href="https://cn.vitejs.dev/guide/dep-pre-bundling.html" target="_blank" rel="noopener noreferrer">依赖预构建</a>实现 CommonJS 和 UMD 兼容性，但并不能解决所有问题，在项目中使用 <strong><a href="https://github.com/perry-mitchell/webdav-client" target="_blank" rel="noopener noreferrer">webdav-client</a></strong> 模块就遇到编译问题，因此引入一个 rollup 插件 <a href="https://github.com/rollup/plugins/tree/master/packages/commonjs/" target="_blank" rel="noopener noreferrer">@rollup/plugin-commonjs</a>，它将 CommonJS 模块转换为 ES6 模块</p><ul><li><p>在终端使用以下命令安装模块和相应的依赖包</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> @rollup/plugin-commonjs --save-dev
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>在 vite 配置文件 <code>vite.config.js</code> 引用插件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">commonjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">crx3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul><h2 id="弹出页面开发" tabindex="-1"><a class="header-anchor" href="#弹出页面开发" aria-hidden="true">#</a> 弹出页面开发</h2><p>在进行弹出页面开发中，主要需要解决的是 Vue <strong>组件间数据传递</strong>问题。</p><p>为了便于代码的复用和维护，将页面分为多个 Vue 组件，例如在弹出页面的浏览状态中，将网页的父级组件 <code>BrowserPage</code> 中主要有 4 大子组件：</p><ul><li><code>BrowserHeader.vue</code></li><li><code>BrowserMenu.vue</code> 和 <code>BrowserMenuPin.vue</code></li><li><code>BrowserGrid.vue</code> 和 <code>BrowserTree.vue</code>，以及 <code>BrowserPin.vue</code></li><li><code>BrowserFooter</code></li></ul><p><img src="/blog-web/assets/tagdown-popup-components.7809551f.png" alt="components"></p><h3 id="父子组件间数据传递" tabindex="-1"><a class="header-anchor" href="#父子组件间数据传递" aria-hidden="true">#</a> 父子组件间数据传递</h3><p>在 Vue 中最常见的组件之间的数据传递方式是使用 <code>prop</code> 和 <code>emit</code> 实现父子组件间传值：</p><ul><li>通过 prop 向子组件传递数据。prop 是在组件上注册的一些<strong>自定义 attribute</strong>。当一个值传递给一个 prop attribute 的时候，它就变成了那个组件实例的一个 property。</li><li>通过 emit 向父组件传递数据。当组件需要修改父层控管的数据（这些数据通过 props 传递进来）时，基于<strong>单向数据流原则</strong>不能在组件内进行修改，而是需要通过 <code>$emit(&#39;eventName&#39;, value)</code> <strong>向外抛出自定义的事件</strong>，通知父层进行数据修改。</li></ul><p>💡 对于输入型的组件，例如在项目中组件 <code>BrowserFooter</code> 包含一个 <code>&lt;input&gt;</code> 元素，可以允许用户输入标签组的名称。可以在组件上使用 <code>v-model</code>，以在父子组件传值的同时实现数据的双向绑定，即数据可以从父层传递给子组件（一般作为变量的初始值），同时可以接收子组件返回的值，以修改绑定的变量。</p><p>在父层使用组件时，通过 <code>v-model</code> 实现数据的双向绑定。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token comment">&lt;!-- 使用组件，为了简洁的演示，省略显示其他属性的绑定 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BrowserFooter</span>
  <span class="token attr-name"><span class="token namespace">v-model:</span>multi-on-group</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multiOnGroup<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name"><span class="token namespace">v-model:</span>new-group-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>newGroupName<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在子组件的表单元素中，绑定相应的属性，同时监听相应的事件：</p><ul><li><p>对于 <code>&lt;input type=&quot;checkbox&quot;&gt;</code> 复选框，绑定的属性是 <code>checked</code>，需要监听的事件是 <code>change</code></p></li><li><p>对于 <code>&lt;input type=&quot;text&quot;&gt;</code> 文本输入框，绑定的属性是 <code>value</code>，需要监听的事件是 <code>input</code></p></li></ul><p>当属性值变更时，需要抛出事件的格式以 <code>update:</code> 为前缀，而属性值通过读取事件对象的相应属性 <code>$event.target</code> 获得</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 省略其他模板内容 --&gt;</span>
  <span class="token comment">&lt;!-- 单个复选框 --&gt;</span>
  <span class="token comment">&lt;!-- 为了简洁的演示，省略显示其他属性的绑定 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
    <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>group<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:checked</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multiOnGroup<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@change</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$emit(<span class="token punctuation">&#39;</span>update:multiOnGroup<span class="token punctuation">&#39;</span>, $event.target.checked)<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span>
    <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>group<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-xs text-gray-500<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>在组内打开<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- 省略其他模板内容 --&gt;</span>
  <span class="token comment">&lt;!-- 文本输入框 --&gt;</span>
  <span class="token comment">&lt;!-- 为了简洁的演示，省略显示其他属性的绑定 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>输入 group 名称<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>newGroupName<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$emit(<span class="token punctuation">&#39;</span>update:newGroupName<span class="token punctuation">&#39;</span>, $event.target.value)<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 省略其他模板内容 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    multiOnGroup<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    newGroupName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">&#39;new&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  emits<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    <span class="token string">&#39;update:multiOnGroup&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;update:newGroupName&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="祖孙组件间数据传递" tabindex="-1"><a class="header-anchor" href="#祖孙组件间数据传递" aria-hidden="true">#</a> 祖孙组件间数据传递</h3><p>用 <code>provide</code> 和 <code>inject</code> 实现从祖先组件向其子孙后代组件传值：</p><ul><li>父组件用 <code>provide</code> 选项或（在组合式 API 中）方法来提供数据，可以提供响应式数据，例如 ref 对象</li><li>子组件用 <code>inject</code> 选项或（在组合式 API 中）方法来接收这个数据</li></ul><p>在项目中多个组件中都需要使用 IndexedDB 数据库，在弹出页的 Vue 入口文件 <code>src/popup/main.js</code> 中使用框架 Dexie.js 创建一个数据库实例，再通过 <code>provide</code> 的方式供其他子组件使用。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Dexie <span class="token keyword">from</span> <span class="token string">&#39;dexie&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;./App.vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&#39;@/styles/tailwind.css&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dexie</span><span class="token punctuation">(</span><span class="token string">&#39;tagdown&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stores</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  bookmark<span class="token operator">:</span> <span class="token string">&#39;id, *tags, *groups&#39;</span><span class="token punctuation">,</span>
  share<span class="token operator">:</span> <span class="token string">&#39;id, share&#39;</span><span class="token punctuation">,</span>
  star<span class="token operator">:</span> <span class="token string">&#39;id, star&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">database</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&#39;db&#39;</span><span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Error occurred</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>然后在组件，例如 <code>BrowserPage.vue</code> 中通过 <code> const db = inject(&#39;db&#39;);</code> 来接收该数据库实例。</p><p>💡 为了便于代码维护，当使用响应式 provide / inject 值时，建议尽可能将<strong>对响应式 property 的修改限制在定义 provide 的组件内</strong>。如果真的需要在注入数据的组件内部更新 inject 的数据，建议同时 provide 一个<strong>方法</strong>来负责改变值，这样可以将数据值的设定和数据修改的逻辑代码都依然集中放在祖父组件中，便于后续跟踪和维护。</p><p>在祖先组件 <code>src/popup/App.vue</code> 中根据响应式变量 <code>Page</code> 控制弹出页面的状态是 <code>&quot;browser&quot;</code> 还是 <code>&quot;edit&quot;</code>，而控制该变量切换的按钮是在后代组件 <code>BrowserFooter.vue</code> 中.</p><p>因此在祖先组件提供修改该变量的方法</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
    
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// provide page state and change the page state function</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&#39;page&#39;</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">changePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    page<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&#39;changePage&#39;</span><span class="token punctuation">,</span> changePage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在后代组件接收该方法，并绑定到按钮上</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 省略其他模板代码 --&gt;</span>
  <span class="token comment">&lt;!-- 为了简洁的演示，省略显示其他属性的绑定 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
    <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>add bookmark<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>changePage(<span class="token punctuation">&#39;</span>edit<span class="token punctuation">&#39;</span>)<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 省略其他模板代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> changePage <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&#39;changePage&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// ...</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    changePage
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="兄弟组件间信息传递" tabindex="-1"><a class="header-anchor" href="#兄弟组件间信息传递" aria-hidden="true">#</a> 兄弟组件间信息传递</h3><p>对于在层级结构中处于「平行」关系，如果需要进行数据传递，可以考虑使用 Vue 官方推荐的数据状态管理插件 <a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener noreferrer">Vuex</a>。</p><p>在项目中有一个需求是通过点击组件 <code>BrowserMenu</code> 的按钮，控制兄弟组件 <code>BrowserGrid</code> 的文件夹展开/折叠。</p><p><img src="/blog-web/assets/tagdown-toggle-folder.3112e95c.gif" alt="toggle folder"></p><p>把兄弟组件的父组件作为信息传递的「桥梁」，在父组件监听其中一个子组件抛出的事件，然后接收到自定义事件时，通过模板引用来调用另一个子组件的方法，从而实现兄弟组件信息传递。</p><p>将父组件 <code>BrowserPage</code> 作为「桥梁」，连接两个「平行」关系子组件。</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 省略其他模板代码 --&gt;</span>
  <span class="token comment">&lt;!-- menu --&gt;</span>
  <span class="token comment">&lt;!-- 为了简洁的演示，省略显示其他属性的绑定 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span>
      <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>browserMenuComponent<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">@unfold-all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>unfoldAllHandler<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">@fold-all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foldAllHandler<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 省略其他模板代码 --&gt;</span>
  <span class="token comment">&lt;!-- 为了简洁的演示，省略显示其他属性的绑定 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BrowserGrid</span>
    <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>grid<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  ref<span class="token punctuation">,</span> computed<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> inject<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
    
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// unfold or fold all folder</span>
    <span class="token keyword">const</span> grid <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 引用 BrowserGrid 组件</span>
    <span class="token keyword">const</span> <span class="token function-variable function">unfoldAllHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      grid<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">unfoldAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用组件中的方法 unfoldAll()</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">foldAllHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      grid<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">foldAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用组件中的方法 foldAll()</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>   

    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      grid<span class="token punctuation">,</span>
      unfoldAllHandler<span class="token punctuation">,</span>
      foldAllHandler<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="页面样式" tabindex="-1"><a class="header-anchor" href="#页面样式" aria-hidden="true">#</a> 页面样式</h3><p>由于 Chrome <a href="https://developer.chrome.com/docs/extensions/reference/action/#popup" target="_blank" rel="noopener noreferrer">限制</a>弹出页面的大小，高和宽的最小值都是是 25px，高的最大值是 600px，宽的最大值是 800px。因此为了尽可能利用空间显示内容，TagDown 将弹出页的浏览状态设置为最大限制</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scss<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">// src/popup/App.vue
.browser-mode</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 800px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 600px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
// ...
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>但是此时弹出页就会出现<strong>滚动条</strong>，可以在弹出页的入口文件 📄 <code>src/popup.html</code> 中为 <code>&lt;body&gt;</code> 元素添加样式，取消它的滚动条</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 省略部分代码 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">body::-webkit-scrollbar</span> <span class="token punctuation">{</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
      <span class="token property">height</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>  
    
<span class="token comment">&lt;!-- 省略部分代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="数据持久化" tabindex="-1"><a class="header-anchor" href="#数据持久化" aria-hidden="true">#</a> 数据持久化</h2><p>参考：</p><ul><li>《现代 JavaScript 教程》<a href="https://zh.javascript.info/indexeddb" target="_blank" rel="noopener noreferrer">IndexedDB</a> 一章</li><li><a href="https://golb.hplar.ch/2017/09/A-closer-look-at-IndexedDB.html" target="_blank" rel="noopener noreferrer">A closer look at IndexedDB</a></li></ul><h3 id="indexeddb-基础" tabindex="-1"><a class="header-anchor" href="#indexeddb-基础" aria-hidden="true">#</a> IndexedDB 基础</h3><p>前端数据持久化有多种方式实现，其中较常用的是通过浏览器自带的 IndexedDB 数据库实现。</p><p>💡 由于扩展程序的后台 service worker 由于 Service workers 无法访问 DOM 和相关的 API，且环境中没有 <code>window</code> 这个变量对象，所以无法使用浏览器提供的 <code>localStorage</code> 和 <code>sessionStorage</code> 进行数据存储。Chrome 为扩展程序提供一个<a href="https://developer.chrome.com/docs/extensions/reference/storage/" target="_blank" rel="noopener noreferrer">数据存储 API <code>chrome.storeage</code></a> ，该 API 可以实现 类似 localStorage 的功能，用于存储<strong>少量</strong>的数据（一般是存储扩展程序的设置参数）。对于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Freference%2Fstorage%2F%23property-sync" target="_blank" rel="noopener noreferrer">sync 同步存储</a>的数据，允许总大小为 100KB；对于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Freference%2Fstorage%2F%23property-local" target="_blank" rel="noopener noreferrer">local 本地存储</a>的数据，允许总大小为 5MB（类似于 localstorage 的存储限制）。</p><p>IndexedDB 具有以下特点：</p><ul><li>通过支持多种类型的键，来存储几乎可以是<strong>任何类型</strong>的值</li><li>支撑事务，有良好的可靠性（<strong>事务</strong>是数据库通用术语，是指一组操作要么全部成功，要么全部失败，不存在中间结果从而导致数据冲突或不完整）</li><li>支持键的范围查询，也支持为数据添加索引</li></ul><p>⚠️ IndexedDB 遵循<strong>同源策略</strong>限制，即每个数据库都是绑定到源（域/协议/端口）的，不同的网站不能相互访问对方的数据库。</p><p>IndexedDB 数据有几个基本的概念，和 SQL、NoSQL 等常用数据库概念类似：</p><ul><li>（同源）网页可以创建一个专属的数据库 Database（遵循同源策略的限制）</li><li>每一个数据库可以创建多个<strong>对象库 ObjectStore</strong>，和 SQL 的表格概念类似</li><li>在对象库中就是以键值对的形式存储着的一条条数据</li></ul><p><img src="/blog-web/assets/IndexedDB.5b1590ef.png" alt="IndexedDB"></p><p>使用 IndexedDB 的基本流程如下：</p><ul><li>创建/打开一个数据库</li><li>定义数据结构，创建<strong>对象库</strong>，指定数据项的键 key（还可以创建索引 index）</li><li>启动<strong>事务</strong>对对数据进行操作</li><li>监听相应的事件</li><li>获取操作结果</li></ul><p>使用方法 <code>open()</code>（连接）一个数据库，第一个参数 <code>name</code> 是数据库名称，数据库可以有许多不同的名称；第二个参数是一个正整数，表示数据库版本，默认为 <code>1</code>。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> openRequest <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>该方法返回 <code>openRequest</code> 对象，我们需要监听该对象上的事件（因为对 IndexedDB APIs 一般都是<strong>异步操作</strong>，待事件触发后才可以在回调函数中执行后续操作）：</p><ul><li><code>success</code>：数据库准备就绪时触发的事件。然后在 <code>openRequest.result</code> 中有了一个数据库对象 Database Object，使用它对数据库进行进一步的调用</li><li><code>error</code>：打开失败时触发的事件</li><li><code>upgradeneeded</code>：数据库已准备就绪，但其版本已过时触发的事件。可以根据需要比较版本，并升级数据结构。升级操作顺利完成后，<strong><code>onsuccess</code> 事件被触发，数据库才算是成功打开了</strong>。</li></ul><p>💡 如果数据库还不存在时（从此时数据库的版本是 <code>0</code>），打开数据库操作就会触发 <code>upgradeneeded</code> 事件，此时可以执行初始化（如创建对象库，指定数据项的键 key，定义数据项的索引 index 等）</p><p>⚠️ 只有在 <code>upgradeneeded</code> 事件的回调函数中，才可以更新升级数据库的结构（例如对象库的创建，以及修改对象库的索引属性）</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> openRequest <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;tagdown&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果浏览器中没有该数据库（或已存在的数据库版本，与打开的版本不符），则会触发 upgradeneeded 事件</span>
openRequest<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 执行初始化</span>
  <span class="token keyword">let</span> bookmark <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">&#39;bookmark&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> keyPath<span class="token operator">:</span> <span class="token string">&quot;id&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> bookmark<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token string">&#39;tags&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;tags&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> multiEntry<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 参数依此表示：索引名称为 tags，对应以数据的哪一个属性作为索引值，由于该属性值为数组，且将数组的每个元素作为索引时需要配置 multiEntry 为 true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 如果浏览器中有该数据库，则会触发 onsuccess 事件</span>
openRequest<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> db <span class="token operator">=</span> openRequest<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
  <span class="token comment">// 继续使用已有的 db 对象处理数据库</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

openRequest<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">,</span> openRequest<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>💡 如果想删除整个数据库（而不是单一条数据），可以使用方法 <code>deleteDatabase(databaseName)</code></p><p>接着，<strong><mark>在 <code>success</code> 事件的回调函数中</mark></strong>，使用方法 <code>transaction</code> 启动事务，对数据进行操作。</p><p>使用事务操作数据的基本流程如下：</p><ul><li><p>使用 <code>db.transaction(store)</code> 创建一个事务，表明要访问的对象库</p></li><li><p>使用 <code>transaction.objectStore(name)</code> 获取存储对象</p></li><li><p>发起请求，操作数据</p></li><li><p>监听请求的成功/错误事件，并执行相应的操作</p></li></ul><p>方法 <code>transaction</code> 创建一个事务，它接收的第一个参数是事务要访问的对象库名称（如果我们要访问多个对象库，则该参数值是抑恶数组）；（可选）第二个参数是事务类型：</p><ul><li><code>readonly</code> 只读，默认值</li><li><code>readwrite</code> 可读取和写入数据（但不能创建/删除/更改的对象库，这类操作只能在 <code>upgradeneeded</code> 事件的回调函数中进行）</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span>store<span class="token punctuation">[</span><span class="token punctuation">,</span> type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>💡 需要两种事务类型，是因为两种类型的事物操作「性能」是不同的。许多 <code>readonly</code> 事务能够同时访问同一存储区；但 <code>readwrite</code> 事务不能。因为 <code>readwrite</code> 事务会「<strong>锁定</strong>」存储区进行写操作，下一个事务必须等待前一个事务完成，才能访问相同的存储区。</p><p>创建事务后，使用事务实例的方法 <code>objectStore(name)</code> 获取相应的对象库，然后就可以对里面的数据项进行操作。对象库支持两种存储值的方法：</p><ul><li>方法 <code>put(value, [key])</code> 将 <code>value</code> 添加到存储区。<strong>如果已经存在相同键的数据，则将替换该值。</strong></li><li>方法 <code>add(value, [key])</code> 与方法 <code>put</code> 类似，<strong>但是如果已经存在相同键的数据，则请求失败</strong>，并生成一个名为 <code>&quot;ConstraInterror&quot;</code> 的错误。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> transaction <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token string">&quot;bookmark&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;readwrite&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个事务，表明要访问的对象库是 bookmark，事务类型是读写</span>

<span class="token comment">// 获取对象库进行操作</span>
<span class="token keyword">let</span> bookmark <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">&quot;bookmark&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 数据项</span>
<span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span>
  title<span class="token operator">:</span> <span class="token string">&#39;Google&#39;</span>
  url<span class="token operator">:</span> <span class="token string">&#39;www.google.com&#39;</span>
  tags<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;search&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;tool&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> request <span class="token operator">=</span> bookmark<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向对象库中添加数据项</span>

<span class="token comment">// 监听请求成功事件</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Bookmark added to the store&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 监听请求失败事件</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>删除特定的数据需要指定查询条件，使用方法 <code>delete(query)</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 删除键值满足 id=&#39;123&#39; 的数据</span>
bookmark<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&#39;123&#39;</span><span class="token punctuation">)</span>；
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>数据库另一个重要功能是搜索数据，IndexedDB 支持两种主要的搜索类型：</p><ul><li>基于一个键或范围进行搜索</li><li>基于一个索引或范围进行搜索</li></ul><p>两者的区别是：由于每个数据的键 key 是特殊唯一的，如果基于单一值搜索，最多获得一个数据项；而索引值可以复用，如果基于单一索引值搜索，可以获得多个数据项。</p><p>使用方法 <code>get(query)</code> 按键 key 搜索数据，返回满足条件的数据项；使用方法 <code>getKey(query)</code> 按键 key 搜索数据，但是返回的是满足条件的数据项的键值</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>bookmark<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;123&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 返回数据项</span>
bookmark<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token string">&#39;123&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 返回 123</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>💡 使用方法 <code>getAll([query], [count])</code> 或 <code>getAllKeys([query], [count])</code> 获取一个范围的数据或键值，返回数组，其中参数 <code>query</code> 表示一个范围，需要通过调用<a href="https://zh.javascript.info/indexeddb#:~:text=%E4%B8%80%E4%B8%AA%E2%80%9C%E9%94%AE%E8%8C%83%E5%9B%B4%E2%80%9D%E3%80%82-,%E4%BD%BF%E7%94%A8%E4%BB%A5%E4%B8%8B%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E5%88%9B%E5%BB%BA%E8%8C%83%E5%9B%B4,-%EF%BC%9A" target="_blank" rel="noopener noreferrer">相应的函数</a>创建。</p><p>💡 <strong>只返回键值</strong>的方法效率更高，该操作不需要解析读取完整的数据</p><p><a href="https://zh.javascript.info/indexeddb#tong-guo-dai-suo-yin-de-zi-duan-sou-suo" target="_blank" rel="noopener noreferrer">通过索引 index 进行查询</a>，也是使用相同的方法，但是通过索引对象调用这些方法。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> tagsIndex <span class="token operator">=</span> bookmark<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;tags&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 索引对象</span>
tagsIndex<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token string">&#39;tool&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取所有标记有 tool 的数据项</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="dexie-js" tabindex="-1"><a class="header-anchor" href="#dexie-js" aria-hidden="true">#</a> Dexie.js</h3><p>虽然 IndexedDB 大部分操作都是异步的，但是方法返回的不是 Promise，而是基于监听事件执行回调的方式来处理操作结果，开发繁琐且代码不易于维护。</p><p>为了便于开发使用一个名为 <strong><a href="https://dexie.org/" target="_blank" rel="noopener noreferrer">Dexie.js</a> 库，它对 IndexedDB APIs 进行二次封装</strong>，让调用 IndexedDB 更方便。该库大部分方法都是异步且返回 Promise。</p><p>与 IndexedDB 类似，它也有相应的不同概念，且不同的类封装了不同的方法</p><ul><li><code>Dexie</code> 该库的核心类，通过该类实例化，可以创建/连接一个 IndexedDB 数据库</li><li>Table 该类表示对象库 ObjectStore</li><li>Collection 该类表示对象库中一部分数据项，可以理解为数据的查询结果</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/</span>
<span class="token comment">// 实例化一个数据库</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dexie</span><span class="token punctuation">(</span><span class="token string">&#39;tagdown&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 声明版本和数据结构（对象库）</span>
db<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stores</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 创建 3 个对象库，键为对象库的名称，值是对象库的中数据项的键和索引，用逗号分隔</span>
  bookmark<span class="token operator">:</span> <span class="token string">&#39;id, *tags, *groups&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 第一个是指定用作为键的属性，之后就是索引</span>
  <span class="token comment">// 加星号 * 表示数据相应属性值为数组，且将数组的每个元素作为索引</span>
  share<span class="token operator">:</span> <span class="token string">&#39;id, share&#39;</span><span class="token punctuation">,</span>
  star<span class="token operator">:</span> <span class="token string">&#39;id, star&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打开/创建数据库，异步操作</span>
db<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">database</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&#39;db&#39;</span><span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过 provide-inject 的方式将数据库对象提供给应用中其他组件使用</span>
  app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Error occurred</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>💡 根据官方的<a href="https://dexie.org/docs/Dexie/Dexie.open()" target="_blank" rel="noopener noreferrer">操作指南</a>，<strong>不必</strong>判断浏览器中是否有已有同名的数据，因为每次尝试连接数据库时，Dexie 会自动判断，按需打开已有数据库或创建一个新数据库。</p><p>以下列出在项目中与数据库相关的一些主要方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/composables/useBookmark.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&#39;db&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 基于键 id 查询数据</span>
<span class="token keyword">const</span> <span class="token function-variable function">getBookmarkDB</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bookmark <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>bookmark<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> bookmark<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 向 bookmark 对象库添加数据</span>
<span class="token keyword">const</span> <span class="token function-variable function">setBookmarkDB</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> bookmark</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log(bookmark);</span>
  <span class="token keyword">await</span> db<span class="token punctuation">.</span>bookmark<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">,</span>
    title<span class="token operator">:</span> bookmark<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
    url<span class="token operator">:</span> bookmark<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
    faviconUrl<span class="token operator">:</span> bookmark<span class="token punctuation">.</span>faviconUrl<span class="token punctuation">,</span>
    tags<span class="token operator">:</span> bookmark<span class="token punctuation">.</span>tags<span class="token punctuation">,</span>
    groups<span class="token operator">:</span> bookmark<span class="token punctuation">.</span>groups<span class="token punctuation">,</span>
    description<span class="token operator">:</span> bookmark<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 基于键 id 删除数据</span>
<span class="token keyword">const</span> <span class="token function-variable function">deleteBookmarkDB</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> db<span class="token punctuation">.</span>bookmark<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>获取索引的所有值</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/options/App.vue</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&#39;db&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取数据库中索引 tags 的所有可能的值</span>
  allTags<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>bookmark<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&#39;tags&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uniqueKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>使用 <code>where</code> 查询语句</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code>// src/options/App.vue
// ...
const db = inject(&#39;db&#39;);
// 筛选条件是索引 share 的值为 1，并返回一个由这些数据的键值构成的数组
const getShareableIds = async () =&gt; {
  const result = await db.share.where(&#39;share&#39;).equals(1).primaryKeys();
  return result;
};
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>将查询结果转换为数组</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code>// src/popup/components/BrowserPage.vue
// ...
const db = inject(&#39;db&#39;);
const starNodes = await db.star.where({ star: 1 }).toArray();
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>导入、导出 IndexedDB 数据库</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code>// src/options/App.vue
// ...
import {
  importDB, exportDB, importInto, peakImportFile,
} from &#39;dexie-export-import&#39;;

// ...
// 导出数据库为 blob
blob = await exportDB(db, {
  prettyJson: true,
});

// ...
// 导入数据库
await importInto(db, file, {
  overwriteValues: true,
}).then(() =&gt; {
  console.log(&#39;import database successful!&#39;);
}).catch((err) =&gt; {
  console.log(err);
});
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="数据同步" tabindex="-1"><a class="header-anchor" href="#数据同步" aria-hidden="true">#</a> 数据同步</h2><p>在扩展程序中使用 <a href="https://www.bilibili.com/video/BV1up4y1s7VP?p=12" target="_blank" rel="noopener noreferrer">WebDAV</a> <strong>同步备份</strong> IndexedDB 数据库。可以将书签按组别<strong>同步分享</strong>为 <a href="https://www.bilibili.com/video/BV1up4y1s7VP?p=10" target="_blank" rel="noopener noreferrer">Gist</a>。</p><h3 id="webdav" tabindex="-1"><a class="header-anchor" href="#webdav" aria-hidden="true">#</a> WebDAV</h3><p>使用 <a href="https://github.com/perry-mitchell/webdav-client" target="_blank" rel="noopener noreferrer">webdav-client</a> 库，它是一个 WebDAV 客户端可用于 NodeJS 或浏览器环境。</p><p>在终端输入以下命令安装该模块及其相应的依赖</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> webdav --save
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>然后基于 WebDAV 服务器地址、用户名、密码创建一个客户端实例</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/composables/useWebDAV.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;webdav/web&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>
<span class="token comment">// create webDAV client</span>
<span class="token keyword">const</span> <span class="token function-variable function">createWebDAVClient</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">,</span>
    password<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> client<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>💡 由于扩展程序的域名和需要访问的 WebDAV 服务器域名不同，扩展程序支持跨域访问其他服务器，但需要将服务器地址添加到扩展程序的配置清单 <code>manifest.json</code> 的<code>host_permissions</code> 属性中，例如使用<a href="https://help.jianguoyun.com/?p=2064" target="_blank" rel="noopener noreferrer">坚果云的 WebDAV 服务</a></p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// 省略显示其他部分</span>
  <span class="token property">&quot;host_permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;https://dav.jianguoyun.com/dav/&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 省略显示其他部分</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以下列出在项目中与 WebDAV 相关的一些主要方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/composables/useWebDAV.js</span>

<span class="token comment">// ...</span>
<span class="token comment">// 检查 WebDAV 服务器连接状态</span>
<span class="token keyword">const</span> <span class="token function-variable function">checkWebDAVConnect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      state<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      msg<span class="token operator">:</span> <span class="token string">&#39;连接成功&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        stateCode<span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;未获得访问权限&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        stateCode<span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;连接失败&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 检查文件夹存在与否，如果不存在就创建一个文件夹</span>
<span class="token keyword">const</span> <span class="token function-variable function">checkWebDAVFolder</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> folderPath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">createDirectory</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 获取文件夹内所有文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">getWebDAVFolder</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> folderPath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">.</span><span class="token function">getDirectoryContents</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">contents</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取文件夹中最后更新的文件</span>
<span class="token comment">// 这里是为了获取 WebDAV 的最后备份同步时间</span>
<span class="token comment">// 由于访问操作会触发文件夹的更新，所以这里实际上是获取文件夹中最后更新的文件的时间戳</span>
<span class="token keyword">const</span> <span class="token function-variable function">getWebDAVLastFileState</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> folderPath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">checkWebDAVFolder</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> folderPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> filesArr <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getWebDAVFolder</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> folderPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>filesArr<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 由于存储的备份文件命名规则是 tagdown_{timestamp}</span>
  <span class="token comment">// 所以文件列表最后一个就是最新创建的备份文件</span>
  <span class="token keyword">const</span> lastFile <span class="token operator">=</span> filesArr<span class="token punctuation">[</span>filesArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> lastFile<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 获取文件内容</span>
<span class="token keyword">const</span> getWebDAVFile <span class="token operator">=</span> <span class="token punctuation">(</span>client<span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> format <span class="token operator">=</span> <span class="token string">&#39;text&#39;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">.</span><span class="token function">getFileContents</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">{</span> format <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 写入文件内容</span>
<span class="token keyword">const</span> <span class="token function-variable function">writeWebDAVFile</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> folderPath<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">checkWebDAVFolder</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> folderPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">putFileContents</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>folderPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    contentLength<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.log(res);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      state<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      msg<span class="token operator">:</span> <span class="token string">&#39;WebDAV 同步成功&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    state<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    msg<span class="token operator">:</span> <span class="token string">&#39;WebDAV 同步失败&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h3 id="gist" tabindex="-1"><a class="header-anchor" href="#gist" aria-hidden="true">#</a> Gist</h3><p>Github 提供了一系列 <a href="https://docs.github.com/en/rest" target="_blank" rel="noopener noreferrer">RESTful API</a>，其中包括一些<a href="https://docs.github.com/en/rest/reference/gists" target="_blank" rel="noopener noreferrer">与 Gist 交互的 APIs</a>。 <a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">申请</a>个人<a href="https://docs.github.com/cn/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="noopener noreferrer">访问令牌</a>，就可以在扩展程序中管理 Gist，将特定的书签以 gist 代码片段的形式分享到 Github。</p><p>💡 由于在引入 <a href="https://www.axios-http.cn/" target="_blank" rel="noopener noreferrer">axios</a> 模块时出错，所以在扩展程序中使用 <code>fetch</code> 向 Github 发送网络请求。</p><p>以下列出在项目中与 WebDAV 相关的一些主要方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/somposables/useGist.js</span>

<span class="token comment">//...</span>
<span class="token comment">// 创建 Gist</span>
<span class="token keyword">const</span> <span class="token function-variable function">createGist</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> gist</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#39;https://api.github.com/gists&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 POST 方法</span>
    method<span class="token operator">:</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 根据官方文档 https://docs.github.com/en/rest/reference/gists#create-a-gist</span>
    <span class="token comment">// 请求体可以设置多种参数，即入参 gist 可以包含以下属性</span>
    <span class="token comment">// * descripton 描述 </span>
    <span class="token comment">// * files（属性值是一个对象，因为一个 Gist 可以包含多个代码文件片段，该对象中，每一个属性就是一个文件，属性名是文件名，属性值是文件内容）</span>
    <span class="token comment">// * public，是否为公开 Gist 或私密 Gist </span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>gist<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 在请求头添加认证信息</span>
    headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">&#39;Content-Type&#39;</span><span class="token operator">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">,</span>
      Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">201</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> resData <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;创建成功&#39;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> resData<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;fail&#39;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;创建失败&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Error:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;创建失败&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更新 Gist</span>
<span class="token keyword">const</span> <span class="token function-variable function">updateGist</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> gistId<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.github.com/gists/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>gistId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 PATCH 方法</span>
    method<span class="token operator">:</span> <span class="token string">&#39;PATCH&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 根据官方文档 https://docs.github.com/en/rest/reference/gists#update-a-gist</span>
    <span class="token comment">// 请求体可以设置多种参数，即入参 data 可以包含以下属性</span>
    <span class="token comment">// * gist_id 需要更新的 Gist ID</span>
    <span class="token comment">// * desciption 描述</span>
    <span class="token comment">// * files 文件 files（属性值是一个对象，因为一个 Gist 可以包含多个代码文件片段，该对象中，每一个属性就是一个文件，属性名是文件名，属性值是文件内容）</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">&#39;Content-Type&#39;</span><span class="token operator">:</span> <span class="token string">&#39;application/json&#39;</span><span class="token punctuation">,</span>
      Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> resData <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;更新成功&#39;</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> resData<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;fail&#39;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;更新失败&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Error:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        state<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">&#39;更新失败&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><h2 id="后台监控" tabindex="-1"><a class="header-anchor" href="#后台监控" aria-hidden="true">#</a> 后台监控</h2><p>⚠️ 如果希望在后台脚本中 <code>import</code> 引入其他库，需要在配置清单 <code>manifest.json</code> 中将后台脚本类型声明为模块 <code>module</code></p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;service_worker&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./background/main.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>扩展程序的后台是一个 service worker，基于监控事件-作出响应的模式执行命令。</p><p>可以在后台监控标签页的切换事件，查询当前激活标签页 URL 是否与任何已保存的书签相匹配，动态更改 Action 图标。实现类似于 Chrome 地址栏右侧的星型图标切换状态，以指示当前标签是否已收藏的功能。</p><p><img src="/blog-web/assets/change-action-icon.2273af65.gif" alt="change action"></p><p>主要使用 Chrome 提供的两个 APIs 实现该功能：</p><ul><li><code>chrome.action.setIcon</code> 动态设置 Action 图标</li><li><code>chrome.tabs.onActivated</code> 监听标签激活事件</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// src/backrground/main.js</span>
<span class="token comment">// ...</span>

<span class="token doc-comment comment">/**
 * 基于当前激活标签是否被收藏，动态更改 Action 图标
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">changeActionIcon</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">tag <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token number">16</span><span class="token operator">:</span> <span class="token string">&#39;/icons/icon16_tag.png&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token number">16</span><span class="token operator">:</span> <span class="token string">&#39;/icons/icon16_untag.png&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 监听标签激活事件，回调函数接收一个对象入参，它包含激活标签的 tabId</span>
chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onActivated<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">activeInfo</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 基于激活标签的 tabId 获取标签对象，从而得到相应的 url</span>
  <span class="token keyword">const</span> tab <span class="token operator">=</span> <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activeInfo<span class="token punctuation">.</span>tabId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> tab<span class="token punctuation">.</span>url <span class="token operator">||</span> tab<span class="token punctuation">.</span>pendingUrl<span class="token punctuation">;</span>
  <span class="token comment">// 基于 url 查找是否有已收藏的书签与之匹配，返回一个包含所有匹配书签节点的数组</span>
  <span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>bookmarks<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> bookmarkState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nodes<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 未找到匹配书签</span>
    bookmarkState <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 找到至少一个匹配书签</span>
    bookmarkState <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>

  <span class="token comment">// 基于书签匹配情况更改 Action 图标</span>
  <span class="token keyword">await</span> <span class="token function">changeActionIcon</span><span class="token punctuation">(</span>bookmarkState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>💡 还可以基于监控其他事件，动态更改 Action 图标：</p><ul><li><code>chrome.windows.onFocusChanged</code> 浏览器窗口更改事件</li><li><code>chrome.tabs.onUpdated</code> 标签更新事件，例如标签页的 URL 更改时</li><li><code>chrome.bookmarks.onCreated</code> 新增书签事件</li></ul><h2 id="设置页面开发" tabindex="-1"><a class="header-anchor" href="#设置页面开发" aria-hidden="true">#</a> 设置页面开发</h2><p>在设置页面中主要提供了 IndexedDB 数据库的导出、导入，以及书签按需导出功能。</p><p>目前有多种库支持在前端将数据导出为文件，例如 <a href="https://github.com/eligrey/FileSaver.js" target="_blank" rel="noopener noreferrer">FileSaver.js</a>、<a href="http://danml.com/download.html" target="_blank" rel="noopener noreferrer">download.js</a>，在 TagDown 的配置页中，用 Vanilla JS 实现了类似的功能：</p><div class="language-vue ext-vue line-numbers-mode"><pre class="language-vue"><code>// src/options/App.vue

const exportJsonFile = (blob, fileName) =&gt; {
  if (!blob) return;
  const a = document.createElement(&#39;a&#39;);
  const url = window.URL.createObjectURL(blob);
  a.href = url;
  a.download = `${fileName}.json`;
  a.click();
};


// 将对象型数据转换为 JSON 格式
const jsonData = JSON.stringify(data, null, 2);
// 再基于 JSON 格式的数据创建 Blob 数据
const blob = new Blob([jsonFile], { type: &#39;application/json&#39; });

// 再触发下载操作
exportJsonFile(blob, &#39;数据导出&#39;)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">更新时间: </span><span class="meta-item-info">2021/10/25 上午7:31:04</span></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><div style="width:0px;" class="catalog-container absolute top-0 right-0 h-full hidden lg:block"><div class="headings-container sticky top-36" data-v-c28348e0><ul class="max-w-max m-2 pl-7 xl:pl-16 2xl:pl-20 py-4 opacity-50 hover:opacity-100 transition-all duration-300" data-v-c28348e0><!--[--><!--]--></ul></div></div><div style="display:none;" tabindex="0" class="sidebar-container fixed inset-y-0 left-0 z-20 lg:hidden opacity-10 hover:opacity-95"><div class="headings-container px-2 space-y-2 transition-all duration-300 py-20" data-v-6eed9461><!--[--><!--]--></div></div></div><footer class="bg-gray-200 p-8 grid grid-cols-1 md:grid-cols-3 gap-4 items-center"><div class="flex justify-center md:justify-start items-center"><a class="p-2 hover:bg-gray-300 rounded-md" href="https://benbinbin.github.io/" target="_blank"><img src="/blog-web/images/avatar.png" alt="avatar" class="w-10 h-10 rounded-full"></a></div><div class="text-center space-y-0.5"><p class="text-sm text-gray-600"> ©2021 <span class="author">Benbinbin</span>. All Right Reserved. </p><p class="text-xs text-center text-gray-400"> 除特殊说明外，本站的文章遵循 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" class="text-blue-400">CC-BY-SA-4.0</a> 协议 </p><p class="text-xs text-center text-gray-400"> 网站主题采用 <a href="https://github.com/Benbinbin/two-dishes-one-fish" target="_blank" class="text-blue-400">Two Dishes One Fish</a></p></div><div class="btn-container flex justify-center md:justify-end items-center space-x-0.5"><!--[--><a class="p-2 hover:bg-gray-300 rounded-md" href="mailto:benthomsonbin@gmail.com" target=""><img src="/blog-web/images/icons/email.svg" alt="email" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://github.com/Benbinbin" target="_blank"><img src="/blog-web/images/icons/github.svg" alt="github" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://juejin.cn/user/3175045314389278/posts" target="_blank"><img src="/blog-web/images/icons/juejin.svg" alt="juejin" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://dribbble.com/BinBinDesign" target="_blank"><img src="/blog-web/images/icons/dribbble.svg" alt="dribbble" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://twitter.com/Benbinbin_fun" target="_blank"><img src="/blog-web/images/icons/twitter.svg" alt="twitter" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://weibo.com/binbindesign" target="_blank"><img src="/blog-web/images/icons/weibo.svg" alt="weibo" class="w-auto h-6"></a><!--]--></div></footer></div><!--]--></div>
    <script type="module" src="/blog-web/assets/app.43fe0c63.js" defer></script>
  </body>
</html>

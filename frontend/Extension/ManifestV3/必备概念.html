<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/blog-web/images/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/katex.min.css"><title>必备概念 | Blog</title><meta name="description" content="A blog and knowledge management system about web.">
    <link rel="modulepreload" href="/blog-web/assets/app.43fe0c63.js"><link rel="modulepreload" href="/blog-web/assets/必备概念.html.d5475543.js"><link rel="modulepreload" href="/blog-web/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/blog-web/assets/必备概念.html.82bc0dc3.js">
    <link rel="stylesheet" href="/blog-web/assets/style.b42fd117.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="min-h-screen flex flex-col"><nav class="px-4 sm:px-8 py-2 flex justify-between items-center sticky top-0 z-30 bg-white"><div class="left flex items-center space-x-0.5"><!--[--><button class="text-gray-400 hover:bg-gray-100 catelog-btn p-2 select-none text-sm font-bold hover:text-gray-900 rounded-md lg:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path></svg></button><!--]--><a class="avatar p-2 hover:bg-gray-100 rounded-md" href="/blog-web/#"><img src="/blog-web/images/avatar.png" alt="avatar" class="w-10 h-10 rounded-full"></a></div><div class="right hidden sm:flex items-center space-x-0.5"><!--[--><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">All</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Network</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Frontend</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Backend</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Project</button><!--]--><!--[--><button class="text-gray-900 bg-gray-100 hover:bg-gray-200 p-2 select-none text-sm font-bold hover:text-gray-900 rounded-md hidden lg:block"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path></svg></button><!--]--></div><div class="more-container sm:hidden relative"><button style="" class="p-2 select-none hover:bg-gray-100 rounded-md text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"></path></svg></button><button style="display:none;" class="p-2 select-none hover:bg-gray-100 rounded-md text-red-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"></path></svg></button><div style="display:none;" class="more-modal p-2 absolute top-10 right-0 z-10 flex flex-col space-y-2 bg-gray-100 rounded-md opacity-90"><!--[--><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">All</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Network</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Frontend</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Backend</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Project</button><!--]--></div></div></nav><div class="relative flex-grow"><div class="theme-container no-navbar no-sidebar"><!--[--><!----><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="必备概念" tabindex="-1"><a class="header-anchor" href="#必备概念" aria-hidden="true">#</a> 必备概念</h1><p>扩展程序由多个部分组成，以下列出了<a href="https://developer.chrome.com/docs/extensions/mv3/devguide/" target="_blank" rel="noopener noreferrer">开发相关的必备概念</a>。</p><h2 id="通用技术" tabindex="-1"><a class="header-anchor" href="#通用技术" aria-hidden="true">#</a> 通用技术</h2><h3 id="service-workers" tabindex="-1"><a class="header-anchor" href="#service-workers" aria-hidden="true">#</a> Service Workers</h3><p>在 Manifest V2 版本中，后台页面 background pages 是扩展程序中的一个独立页面，一般设置事件监听，以响应用户的操作，但是它会长期驻留后台影响性能。在 Manifest V3 版本中，后台脚本迁移到 Service Workers 中运行以提供性能，其中有两个特点：</p><ul><li>Service Workers 在执行事件处理函数后终止，并在新的事件触发下重新运行</li><li>它是一种 <a href="https://www.html5rocks.com/en/tutorials/workers/basics/" target="_blank" rel="noopener noreferrer">JavaScript Worker</a>，<strong>无法直接访问 DOM</strong>。</li></ul><p>💡 <a href="https://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener noreferrer">Service Worker</a> 是浏览器<strong>完全独立于网页运行</strong>的脚本。除了以上的特点，还要注意以下的相关事项：</p><ul><li>它是一种可编程网络代理，让您能够控制页面所发送网络请求的处理方式。</li><li>它广泛地利用了 promise 进行异步操作。</li></ul><p>如果需要使用 service workers 时需要在配置清单 <code>manifest.json</code> 的选项 <code>background.service_worker</code> 中声明注册，属性值指定需要执行的一个 JavaScript 文档的路径（它必须在项目的根目录下）。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;service_worker&quot;</span><span class="token operator">:</span> <span class="token string">&quot;background.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>后台脚本在 Service Workers 中运行基于监听事件-响应模型来执行操作，因此逻辑代码的编写也应该遵循该模型以优化性能：</p><ul><li><p>在事件循环的第一轮中完成事件监听的注册，即将事件监听程序写在后台脚本最顶层的作用域中，而不应该内嵌在其他的逻辑代码中（因为 Service Workers 执行完代码会终止而不会长期驻留，当有事件需要分派时它才再次运行，如果未能在第一次事件轮询中注册监听器，这就无法响应事件）。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;badgeText&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> badgeText <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setBadgeText</span><span class="token punctuation">(</span><span class="token punctuation">{</span> text<span class="token operator">:</span> badgeText <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Listener is registered on startup</span>
chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span>onClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>handleActionClick<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">handleActionClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li><li><p>由于 Service Workers 生命周期是<strong>短期的</strong>，如果需要持久化的数据（例如需要将用户输入的内容作为变量），可以使用 Chrome 为扩展程序提供的 <a href="https://developer.chrome.com/docs/extensions/reference/storage/" target="_blank" rel="noopener noreferrer">Storage API</a></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> type<span class="token punctuation">,</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&quot;set-name&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span>onClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li><li><p>在 Manifest V2 版本中使用 <code>setTimeout</code> 或 <code>setInterval</code> 实现延迟或定期操作，在 Manifest V3 版本的 Service Workers 中并<strong>不</strong>可行，因为 Service Worker 并不会长期驻留后台，当它终止时调度程序会注销计时器。我们应该使用 <a href="https://developer.chrome.com/docs/extensions/reference/alarms/" target="_blank" rel="noopener noreferrer">Alarms API</a> 来替代，它用以安排代码定期运行或在未来的指定时间运行。它也需要在后台脚本最顶层的作用域中注册。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> delayInMinutes<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set an alarm, which will dispatch onAlarm event after 3 mins</span>

<span class="token comment">// listen the onAlarm event and react to it</span>
chrome<span class="token punctuation">.</span>alarms<span class="token punctuation">.</span>onAlarm<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token function">getRandomIconPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul><p>Service Worker 实际上是一个 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker" target="_blank" rel="noopener noreferrer">web worker</a>，在浏览器中可以独立于网页运行，一般网页的执行上下文中都有<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window" target="_blank" rel="noopener noreferrer">全局变量 <code>window</code></a>，可以通过它访问一些浏览器提供的 API，例如 IndexedDB、cookie、localStorage 等，但在 Service Worker 中没有该对象，因此有诸多限制，例如在该环境中无法访问 DOM，无法发起 XMLHttpRequest（但支持 fetch 功能），以下是应对限制的一些解决方法：</p><ul><li><p>由于 Service Workers 无法访问 <a href="https://developer.mozilla.org/en-US/docs/Web/API/DOMParser" target="_blank" rel="noopener noreferrer">DOMParser API</a> 以解析 HTML，我们可以通过 <code>chrome.windows.create()</code> 和 <code>crhome.tabs.create()</code> API 创建一个标签页，以提供一个具有 window 对象的环境，或借助一些库（如 <a href="https://github.com/jsdom/jsdom" target="_blank" rel="noopener noreferrer">jsdom</a> 或 <a href="https://github.com/developit/undom" target="_blank" rel="noopener noreferrer">undom</a>）弥补这个缺失。</p></li><li><p>在 Service Workers 中无法播放或捕获多媒体资源，可以通过 <code>chrome.windows.create()</code> 和 <code>crhome.tabs.create()</code> API 创建一个标签页，以提供一个具有 window 对象的环境，然后可以通过<a href="https://developer.chrome.com/docs/extensions/mv3/messaging/" target="_blank" rel="noopener noreferrer">消息传递 message passing</a> 在 service worker 中控制页面的多媒体播放。</p></li><li><p>虽然在 Service Worker 中无法访问 DOM，但可以通过 <a href="https://html.spec.whatwg.org/multipage/canvas.html#the-offscreencanvas-interface" target="_blank" rel="noopener noreferrer"><code>OffscreenCanvas</code> API</a> 创建一个 canvas。关于 OffscreenCanvas 相关信息可以参考<a href="https://developers.google.com/web/updates/2018/08/offscreen-canvas" target="_blank" rel="noopener noreferrer">这里</a>。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
<span class="token comment">// for MV3 service workers</span>
<span class="token keyword">function</span> <span class="token function">buildCanvas</span><span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OffscreenCanvas</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> canvas<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul><h3 id="message-passing" tabindex="-1"><a class="header-anchor" href="#message-passing" aria-hidden="true">#</a> Message Passing</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/mv3/messaging/#external" target="_blank" rel="noopener noreferrer">Message passing</a></li><li>关于 Message Passing <a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/messaging" target="_blank" rel="noopener noreferrer">官方示例</a></li></ul><p>注入到页面的脚本 content scripts 是在网页运行的，它「脱离」了扩展程序，但可以使用信息传递 message passing 进行沟通（在 web page 的页面脚本 content script 和扩展程序之间），Chrome 除了提供简单的 API 进行一次性的请求-响应通讯，也提供复杂的 API 进行长连接通讯，还可以基于 ID 进行跨扩展程序的通讯。</p><p>💡 任何合法的 JSON 格式的数据都可以传递。</p><p>💡 甚至可以<a href="https://developer.chrome.com/docs/apps/nativeMessaging/" target="_blank" rel="noopener noreferrer">与本机系统进行通讯</a>。</p><p>⚠️ 信息传递过程中需要考虑安全问题：</p><ul><li><p>内容脚本 content scripts 更容易遭受恶意网页攻击，应该限制通过 content script 传递过来的信息，可以触发的操作范围</p></li><li><p>当扩展程序与外部资源进行通讯时，应该采取必要的行为避免发生跨站脚本攻击</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// WARNING! Might be injecting a malicious script!</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;resp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> response<span class="token punctuation">.</span>farewell<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// innerText does not let the attacker inject HTML elements.</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;resp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> response<span class="token punctuation">.</span>farewell<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// JSON.parse does not evaluate the attacker&#39;s scripts.</span>
  <span class="token keyword">var</span> resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>farewell<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ul><h4 id="一次性请求" tabindex="-1"><a class="header-anchor" href="#一次性请求" aria-hidden="true">#</a> 一次性请求</h4><p>使用<a href="https://developer.chrome.com/docs/extensions/reference/runtime/#method-sendMessage" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.sendMessage()</code></a> 或<a href="https://developer.chrome.com/docs/extensions/reference/tabs/#method-sendMessage" target="_blank" rel="noopener noreferrer">方法 <code>chome.tabs.sendMessage()</code></a> 进行<strong>单次请求</strong>，这两个方法可以设置回调函数，默认接收返回的响应数据作为参数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在页面脚本 content script 发送信息</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>farewell<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在扩展程序发送信息</span>
<span class="token comment">// 需要先使用 query 获取 tabId，以指定该请求发送给哪个特定的 tab 标签页面</span>
chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>active<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> currentWindow<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tabs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 发送到当前激活的标签页面</span>
  chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tabs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>greeting<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>farewell<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在接收端，植入页面的代码 content script 和扩展程序的后台代码 background script 都一样，需要使用<a href="https://developer.chrome.com/docs/extensions/reference/runtime/#event-onMessage" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.onMessage.addListener()</code></a> <strong>监听相应的事件以捕获请求</strong>。事件处理函数接收三个参数，第一参数是接收到的信息；第二个参数是一个对象，它包含这次 message 的发送方的相关信息；第三个参数是一个方法，发送响应内容。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span>tab <span class="token operator">?</span>
    <span class="token string">&quot;from a content script:&quot;</span> <span class="token operator">+</span> sender<span class="token punctuation">.</span>tab<span class="token punctuation">.</span>url <span class="token operator">:</span>
    <span class="token string">&quot;from the extension&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>greeting <span class="token operator">===</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>farewell<span class="token operator">:</span> <span class="token string">&quot;goodbye&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>💡 以上事件处理函数中，发送响应是同步执行的，即接收到 message 触发事件处理函数后，执行到 <code>sendResponse</code> 函数时就会立即发送响应；如果希望异步发送响应（例如需要整合其他异步请求的数据），可以在 <code>onMessage</code> 事件处理函数的最后，显性返回 <code>return true</code>，告知扩展程序响应会异步执行，这样信息通道 message channel 还会保持打开，直到 <code>sendResponse</code> 被调用。</p><p>💡 如果在不同页面设置了多个 <code>onMessage</code> 事件监听器，<strong>为了保证只有一次响应，对于每次 message 请求扩展程序整体都只会最多执行一次 <code>sendResponse()</code> 方法</strong>，其他事件处理函数中的响应函数都会被忽略。</p><h4 id="长连接" tabindex="-1"><a class="header-anchor" href="#长连接" aria-hidden="true">#</a> 长连接</h4><p>可以使用<a href="https://developer.chrome.com/docs/extensions/reference/runtime/#method-connect" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.connect()</code></a> 或<a href="https://developer.chrome.com/docs/extensions/reference/tabs/#method-connect" target="_blank" rel="noopener noreferrer">方法 <code>chrome.tabs.connect()</code></a> 为内容脚本 content script 和扩展程序之间<strong>建立一个长连接</strong>（可以为信息通道 channel 设置名称，以区别多个通道）。</p><p>使用以上方法创建通道后，会返回一个 <a href="https://developer.chrome.com/docs/extensions/reference/runtime/#type-Port" target="_blank" rel="noopener noreferrer"><code>runtime.Port</code> 端口对象</a>，其中包括了关于信息通道的相关方法和属性，然后就可以通过该通道发送 <code>portObj.postMessage()</code> 和接收 <code>portObj.onMessage.addListener()</code> 信息。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在页面脚本 content script 建立长连接的信息通道</span>
<span class="token keyword">var</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">&quot;knockknock&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过该端口发送信息</span>
port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>joke<span class="token operator">:</span> <span class="token string">&quot;Knock knock&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置事件监听器，通过该端口接收信息，将接收到的信息作为入参</span>
port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>question <span class="token operator">===</span> <span class="token string">&quot;Who&#39;s there?&quot;</span><span class="token punctuation">)</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>answer<span class="token operator">:</span> <span class="token string">&quot;Madame&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>question <span class="token operator">===</span> <span class="token string">&quot;Madame who?&quot;</span><span class="token punctuation">)</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>answer<span class="token operator">:</span> <span class="token string">&quot;Madame... Bovary&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>类似地，如果在扩展程序中建立长连接发送消息时，使用方法 <code>chrome.tabs.connect()</code>，需要指定请求是发送给哪个特定的 tab 标签页。</p><p>信息通道是双向的，因此除了发起端创建端口，还需要在接收端使用<a href="https://developer.chrome.com/docs/extensions/reference/runtime#event-onConnect" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.onConnect()</code></a> <strong>响应通道连接请求</strong>（在内容脚本 content script 和扩展程序中一样）。当通道发起端口调用 connect 方法时，接收端的监听器就会调用回调函数，它将相应的 <code>runtime.Port</code> 端口对象作为入参，然后可以使用该端口在通道中发送和接收消息，这样通道两端的接口就可以<strong>相互接收和发送信息</strong>了。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnect<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>port<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;knockknock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>joke <span class="token operator">===</span> <span class="token string">&quot;Knock knock&quot;</span><span class="token punctuation">)</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>question<span class="token operator">:</span> <span class="token string">&quot;Who&#39;s there?&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>answer <span class="token operator">===</span> <span class="token string">&quot;Madame&quot;</span><span class="token punctuation">)</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>question<span class="token operator">:</span> <span class="token string">&quot;Madame who?&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>answer <span class="token operator">===</span> <span class="token string">&quot;Madame... Bovary&quot;</span><span class="token punctuation">)</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>question<span class="token operator">:</span> <span class="token string">&quot;I don&#39;t get it.&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="端口生命周期" tabindex="-1"><a class="header-anchor" href="#端口生命周期" aria-hidden="true">#</a> 端口生命周期</h4><p>信息通道连接是长期的，但也可能因为以下原因断开：</p><ul><li><p>在接收端没有设置监听器 <code>chrome.runtime.onConnect()</code> 无法成功建立通道</p></li><li><p>使用 <code>chrome.tabs.connect()</code> 创建通道时，期望连接的端口所在的页面不存在</p></li><li><p>All frames that received the port (via <a href="https://developer.chrome.com/docs/extensions/reference/runtime#event-onConnect" target="_blank" rel="noopener noreferrer">runtime.onConnect</a>) have unloaded.</p></li><li><p>端口对象调用了方法 <code>chrome.runtime.Port.disconnect()</code> 结束连接</p><p>💡 如果发起端口调用 connect 后，建立多个接收端口（创建多个信息通道），在其中一个接收端口调用 disconnect 时，则 <strong><code>onDisconnect</code> 事件</strong>只会在发起端口触发，其他端口并不会触发。</p></li></ul><p>可以使用方法 <code>port.onDisconnect()</code> 监听该端口的断连事件（其中 <code>port</code> 是端口对象），事件处理函数的入参是该端口对象。</p><h4 id="跨扩展程序的通讯" tabindex="-1"><a class="header-anchor" href="#跨扩展程序的通讯" aria-hidden="true">#</a> 跨扩展程序的通讯</h4><p>除了在扩展程序内进行信息传递，还可以使用类似的 messaging API 在不同扩展程序间进行通讯。</p><p>发送请求信息时，必须提供扩展程序的 ID，以便其他扩展程序判断是否作出响应。使用方法 <code>chrome.runtime.sendMessage(id, message)</code> 发送一次性的请求；使用方法 <code>chrome.runtime.connect(id)</code> 发起通道连接请求，并返回端口对象。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// The ID of the extension we want to talk to.</span>
<span class="token keyword">var</span> laserExtensionId <span class="token operator">=</span> <span class="token string">&quot;abcdefghijklmnoabcdefhijklmnoabc&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Make a simple request:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>laserExtensionId<span class="token punctuation">,</span> <span class="token punctuation">{</span>getTargetData<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">targetInRange</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>targetData<span class="token punctuation">)</span><span class="token punctuation">)</span>
      chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>laserExtensionId<span class="token punctuation">,</span> <span class="token punctuation">{</span>activateLasers<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start a long-running conversation:</span>
<span class="token keyword">var</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>laserExtensionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>对于一次性的请求，使用方法 <code>chrome.runtime.onMessageExternal()</code> 进行监听并作出响应；对于长连接，使用方法 <code>chrome.runtime.onConnectExternal()</code> 响应连接，并使用端口对象接收和发送信息。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// For simple requests:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessageExternal<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sender<span class="token punctuation">.</span>id <span class="token operator">===</span> blocklistedExtension<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// don&#39;t allow this extension access</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>getTargetData<span class="token punctuation">)</span>
      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>targetData<span class="token operator">:</span> targetData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>activateLasers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token function">activateLasers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>activateLasers<span class="token operator">:</span> success<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// For long-lived connections:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onConnectExternal<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  port<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// See other examples for sample onMessage handlers.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="网页通讯" tabindex="-1"><a class="header-anchor" href="#网页通讯" aria-hidden="true">#</a> 网页通讯</h4><p>类似于跨扩展程序间通讯，一般的网页可以发送信息给扩展程序。而扩展程序需要在配置清单 <code>manifest.json</code> 的选项 <code>externally_connectable.matches</code> 中声明注册，希望与哪些外部网页进行连接（可以使用正则表达式，以支持一系列符合一定规则的网页，但<strong>至少包含二级域</strong>）</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;externally_connectable&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;matches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://*.example.com/*&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在网页使用方法 <code>chrome.runtime.sendMessage()</code> 或方法 <code>chrome.runtime.connect()</code> 发送信息（通过 ID 来指定与哪一个扩展程序进行通讯）</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// The ID of the extension we want to talk to.</span>
<span class="token keyword">var</span> editorExtensionId <span class="token operator">=</span> <span class="token string">&quot;abcdefghijklmnoabcdefhijklmnoabc&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Make a simple request:</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>editorExtensionId<span class="token punctuation">,</span> <span class="token punctuation">{</span>openUrlInEditor<span class="token operator">:</span> url<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token function">handleError</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在扩展程序使用方法 <code>chrome.runtime.onMessageExternal()</code> 或方法 <code>chrome.runtime.onConnectExternal()</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessageExternal<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sender<span class="token punctuation">.</span>url <span class="token operator">===</span> blocklistedWebsite<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// don&#39;t allow this web page access</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>openUrlInEditor<span class="token punctuation">)</span> <span class="token function">openUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>openUrlInEditor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>💡 当扩展程序与一般的网页通讯时，长连接只能通过网页端发起。</p><h3 id="options-pages" tabindex="-1"><a class="header-anchor" href="#options-pages" aria-hidden="true">#</a> Options Pages</h3><p>设置页面允许用户定制扩展程序，以更符合自己的使用习惯。</p><p>如果要为扩展程序添加设置页面，需要先在配置清单 <code>manifest.json</code> 的中进行声明注册，有两种类型的设置页面：</p><ul><li><p>Full page options 整页的设置页面，需要打开一个标签页。</p><p>在配置清单的选项 <code>options_page</code> 中声明注册作为设置页面的 HTML 文档的路径</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;options_page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;options.html&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后用户可以在浏览器工具栏的扩展程序图标右键点击选择「<strong>选项</strong>」打开设置页面</p><p><img src="/blog-web/assets/open-options-page-1.e7479be3.png" alt="打开设置页面-1"></p><p>或者在扩展程序的「<strong>详情</strong>」页面中选择「<strong>扩展程序选项</strong>」打开设置页面</p><p><img src="/blog-web/assets/open-options-page-2.3d6a4197.png" alt="打开设置页面-2"></p></li><li><p>Embedded Options 内嵌的设置页面，以模态框的形式展示设置页面。</p><p>💡 模态框的大小会根据页面内容自动调整，但有时候可能并不奏效，此时可以为设置页面先提供一个<strong>最小的尺寸</strong>，以保证布局正常显示。</p><p>在配置清单的选项 <code>options_ui.page</code> 中指向相应的 HTML 文档路径，并设置属性 <code>option_ui.open_in_tab</code> 为 <code>false</code>，表示采用内嵌设置页（如果设置为 <code>true</code> 就会打开新的标签页来展示设置页面）。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;options_ui&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;options.html&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;open_in_tab&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后用户就可以在在浏览器工具栏的扩展程序图标右键点击选择「<strong>选项</strong>」，会跳转到相应扩展程序的详情页，同时打开模态框展示设置页面；或者在扩展程序的「<strong>详情</strong>」页面中选择「<strong>扩展程序选项</strong>」，打开模态框展示设置页面。</p><p><img src="/blog-web/assets/open-options-page-3.13aaf8b4.png" alt="打开设置页"></p></li></ul><p>💡 在扩展程序的页面中可以通过方法 <code>chrome.runtime.openOptionsPage()</code> 打开设置页面</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>go-to-options<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Go to options<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#go-to-options&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先判断浏览器是否支持该方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>openOptionsPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">openOptionsPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不支持就手动基于页面路径打开设置页面</span>
    window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token string">&#39;options.html&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>虽然两种方式都可以供用户设置参数，但是有一些不同：</p><ul><li><p>对于内嵌型的设置页面，不支持部分 Tabs 相关的 API</p><ul><li>无法使用 <a href="https://developer.chrome.com/docs/extensions/reference/tabs#method-query" target="_blank" rel="noopener noreferrer">方法 <code>chrome.tabs.query()</code></a> 通过设置页面的 URL 找到对应的 tab</li><li>打开设置页面时，<a href="https://developer.chrome.com/docs/extensions/reference/tabs/#event-onCreated" target="_blank" rel="noopener noreferrer">事件 <code>chrome.tabs.onCreated.addListener()</code></a> 无法被监听到</li><li>当设置页面重载时，<a href="https://developer.chrome.com/docs/extensions/reference/tabs/#event-onUpdated" target="_blank" rel="noopener noreferrer">事件 <code>chrome.tabs.onUpdated.addListener()</code></a> 无法被监听到</li></ul></li><li><p>无法使用<a href="https://developer.chrome.com/docs/extensions/reference/tabs/#method-connect" target="_blank" rel="noopener noreferrer">方法 <code>chrome.tabs.connect()</code></a> 和<a href="https://developer.chrome.com/docs/extensions/reference/tabs/#method-sendMessage" target="_blank" rel="noopener noreferrer">方法 <code>chrome.tabs.sendMessage()</code></a> 发送信息，但<a href="https://developer.chrome.com/docs/extensions/runtime#method-connect" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.connect()</code></a> 和<a href="https://developer.chrome.com/docs/extensions/runtime#method-sendMessage" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.sendMessage()</code></a> 并不受限制。</p><p>💡 如果设置页面使用<a href="https://developer.chrome.com/docs/extensions/runtime#method-connect" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.connect()</code></a> 和<a href="https://developer.chrome.com/docs/extensions/runtime#method-sendMessage" target="_blank" rel="noopener noreferrer">方法 <code>chrome.runtime.sendMessage()</code></a> 传递信息，接收者并不能读取发送者 sender 的 tab 信息，只能读取到发送者的 url 信息（设置页面文档的路径）</p></li></ul><p>💡 为了可以让用户的设置数据持久化及跨设备同步，可以使用 Chrome 提供的 <a href="https://developer.chrome.com/docs/extensions/reference/storage#property-sync" target="_blank" rel="noopener noreferrer"><code>storage.sync</code> API</a>，记得先在配置清单 <code>manifest.json</code> 中声明注册 <code>strage</code> 权限</p><h3 id="permissions" tabindex="-1"><a class="header-anchor" href="#permissions" aria-hidden="true">#</a> Permissions</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/permissions/" target="_blank" rel="noopener noreferrer"><code>chrome.permissions</code> API</a></li><li><a href="https://developer.chrome.com/docs/extensions/mv3/declare_permissions/" target="_blank" rel="noopener noreferrer">Declare permissions</a></li><li><a href="https://developer.chrome.com/docs/extensions/mv3/permission_warnings/" target="_blank" rel="noopener noreferrer">Declare permissions and warn users</a></li></ul><p>限制扩展程序的权限，不仅可以降低扩展程序被恶意程序利用的可能性；还可以让用户有主动选择权，决定应该给扩展程序授予哪些权限可选。</p><p>扩展程序为了可以使用部分 Chrome APIs 和访问外部网页，需要在配置清单 <code>manifest.json</code> 中以<strong>显式声明</strong>所需的权限，有三种选项以声明不同的权限：</p><ul><li><code>permissions</code> 用于设置必要权限许可 required permissions，所有可以使用的 permissions 字段可以在<a href="https://developer.chrome.com/docs/extensions/mv3/declare_permissions/" target="_blank" rel="noopener noreferrer">这里</a>查看，以数组的形式包含多个字段。为了实现扩展程序的基本功能，在安装时询问用户</li><li><code>optional_permissions</code> 用于设置可选权限许可 optional permissions，也是以以数组的形式包含多个字段。为了实现某些可选的功能（一般是访问特定的数据或资源），在扩展程序运行时才询问用户，以获取权限许可。</li><li><code>host_permissions</code> 专门用于设置扩展程序可以去访问哪些主机的权限，包含一系列<a href="https://developer.chrome.com/docs/extensions/mv3/match_patterns/" target="_blank" rel="noopener noreferrer">用于匹配 url 的正则表达式</a></li></ul><p>然后浏览器会在扩展程序安装时或在运行时，询问用户是否允许它获取相应的权限、访问特定的资源，让用户可以有主动权去保护自己的数据，具体哪些权限会通知用户或是询问让用户主动选择，可以查看<a href="https://developer.chrome.com/docs/extensions/mv3/permission_warnings/" target="_blank" rel="noopener noreferrer">这里</a>。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;tabs&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bookmarks&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;unlimitedStorage&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;optional_permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;unlimitedStorage&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;host_permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;http://www.blogger.com/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;http://*.google.com/&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>💡 在配置清单 <code>manifest.json</code> 里所有可以声明的 permissions 字段可以在<a href="https://developer.chrome.com/docs/extensions/mv3/declare_permissions/" target="_blank" rel="noopener noreferrer">这里</a>查看，但是部分字段并<strong>不</strong>能在可选权限 <code>optional_permissions</code> 选项中声明：</p><ul><li><code>debugger</code></li><li><code>declarativeNetRequest</code></li><li><code>devtools</code></li><li><code>experimental</code></li><li><code>geolocation</code></li><li><code>mdns</code></li><li><code>proxy</code></li><li><code>tts</code></li><li><code>ttsEngine</code></li><li><code>wallpaper</code></li></ul><p>除了可以在配置清单中设置可选权限许可，还可以在扩展程序的逻辑代码中，基于用户主动交互（例如在按钮的点击事件的处理函数中）中使用方法 <code>chrome.permissions.request()</code> 动态申请。如果申请的权限会触发警告提示，则会弹出一个权限提示框询问用户许可，并等待结果返回再执行后续的代码</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#my-button&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Permissions must be requested from inside a user gesture, like a button&#39;s</span>
  <span class="token comment">// click handler.</span>
  chrome<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    permissions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;tabs&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    origins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;https://www.google.com/&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">granted</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// The callback argument will be true if the user granted the permissions.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>granted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>如果不再需要某项权限时，可以使用方法 <code>chrome.permissions.remove()</code> 删除该权限，如果之后再使用方法 <code>chrome.permissions.request()</code> 动态添加相应的权限，则不必再告知用户</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  permissions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;tabs&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  origins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;https://www.google.com/&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">removed</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The permissions have been removed.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// The permissions have not been removed (e.g., you tried to remove</span>
    <span class="token comment">// required permissions).</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>💡 可以使用方法 <code>chrome.permissions.contains()</code> 查看扩展程序当前是否拥有某项权限，使用方法 <code>chrome.permissions.getAll()</code> 获取扩展程序当前具有的所有权限</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  permissions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;tabs&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  origins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;https://www.google.com/&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The extension has the permissions.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// The extension doesn&#39;t have the permissions.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>💡 有一些权限获取时，会<strong>弹出警告提示</strong>，你可以在这里查看<a href="https://developer.chrome.com/docs/extensions/mv3/permission_warnings/#permissions_with_warnings" target="_blank" rel="noopener noreferrer">相关的权限</a>。</p><p><img src="/blog-web/assets/permission-warning.3a5fe231.png" alt="权限警告"></p><p>为了避免在安装扩展程序时，<strong>由于弹出的过多的警告而降低了安装量，应该在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中只声明核心功能所必需的权限，而尽量包含需要弹出警告的权限，而应该将这些权限在选项 <code>optional_permissions</code> 中声明</strong>，然后使用交互控件，如按钮或 checkbox，让用户主动激活可选功能，此时才弹出权限警告框，让用户主动选择是否授权，这样的交互体验会更佳。</p><p>💡 如果更新扩展程序时，新增了 permissions 会导致扩展程序临时无法激活，需要用户再起允许授权才可以，如果将这些新增的 permissions 放在选项 <code>optional_permissions</code> 则可以避免这个不好的体验。</p><p>💡 声明 <code>activeTab</code> 权限可以<strong>临时获取许可访问当前激活的标签页</strong>，并在当前页面使用 <a href="https://developer.chrome.com/docs/extensions/reference/tabs/" target="_blank" rel="noopener noreferrer">tabs 相关的 API</a>（当导航到其他 url 或关闭当前页面后，该路径的可访问性就失效），一般用以替代 <code>&lt;all_urls&gt;</code> 权限，达到访问任意 url 的当前页面，而且不会在安装扩展程序时弹出警告。</p><p>💡 对于在「开发者模式」下「加载已解压的扩展程序」，并<strong>不</strong>会展示权限警告提示。如果希望查看警告提示的效果，可以相对开发的扩展程序进行<strong>打包</strong>，具体步骤请参考<a href="https://developer.chrome.com/docs/extensions/mv3/permission_warnings/" target="_blank" rel="noopener noreferrer">官方指南</a>。</p><h3 id="storage" tabindex="-1"><a class="header-anchor" href="#storage" aria-hidden="true">#</a> Storage</h3><p>扩展程序可以在浏览器中存储和检索数据。</p><p>Chrome 浏览器为拓展出现提供数据存储 API <code>chrome.storeage</code> ，该 API 提供类似 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" target="_blank" rel="noopener noreferrer">localStorage </a> 的功能，但也有一些不同：</p><ul><li>使用 <code>chrome.storage.sync</code> 相关方法，就可以利用 Chrome 的<strong>同步</strong>功能，实现同一账户下的扩展程序数据在多个设备之间同步。💡 如果已登录账户的 Chrome 离线时，希望同步存储的数据会先进行本地存储，等待浏览器上线后再进行同步。如果用户在 Chrome 设置中取消了数据同步功能，那么 <code>chrome.storage.sync</code> 相关方法的作用和 <code>chrome.storage.local</code> 一样</li><li>批量的读取和写入数据操作是<strong>异步执行</strong>的，因此与 localStorage 引起的阻塞和串行相比操作更快</li><li>存储的<strong>数据类型可以是对象</strong>，而 localStorage 只允许存储字符串</li><li>Enterprise policies configured by the administrator for the extension can be read (using <code>storage.managed</code> with a <a href="https://developer.chrome.com/docs/extensions/mv2/manifest/storage/" target="_blank" rel="noopener noreferrer">schema</a>). The <code>storage.managed</code> storage is read-only.</li></ul><p>💡 有三种不同的存储域 StorageArea</p><ul><li><code>sync</code> 同步存储的数据</li><li><code>local</code> 本地存储的数据</li><li><code>managed</code> 管理员设置的数据，只读</li></ul><p>如果要使用该 API 需要先在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中声明注册权限</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;storage&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>存储扩展程序的数据时，以键值对的形式（数据格式是对象），可以使用方法 <code>chrome.storage.local.set({key: value}, callback())</code> 存储在本地，或使用方法 <code>chrome.storage.sync.set({key: value}, callback())</code> 进行同步存储，相应地分别使用方法 <code>chrome.storage.local.get()</code> 或 <code>chrome.storage.sync.get()</code> 获取对应 key 的数据</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// sync</span>
chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>key<span class="token operator">:</span> value<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Value is set to &#39;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;key&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Value currently is &#39;</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// local</span>
chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>key<span class="token operator">:</span> value<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Value is set to &#39;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;key&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Value currently is &#39;</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>💡 获取 get 数据时，不仅可以传入 key 字符串，也可以传入 keys 数组，以返回对应的一系列数据。如果获取 get 数据时，传入的 key 为 <code>null</code> 则会返回<strong>所有</strong>存储的数据。</p><p>💡 如果想删除某个 key 的数据，可以使用方法 <code>chrome.storage.remove(key, callback())</code>。如果要清空所有存储的数据，可以使用方法 <code>chrome.storage.clear(callback())</code></p><p>⚠️ 与用户相关机密数据请不要进行存储，因为使用该 API 所存储的数据<strong>并不会</strong>加密。</p><p>该 API <strong>允许存储的数据并不大</strong>，对于 <a href="https://developer.chrome.com/docs/extensions/reference/storage/#property-sync" target="_blank" rel="noopener noreferrer">sync 同步存储</a>的数据，允许总大小为 100KB，最多存储 512 个数据项，每项大小为 8KB；对于 <a href="https://developer.chrome.com/docs/extensions/reference/storage/#property-local" target="_blank" rel="noopener noreferrer">local 本地存储</a>的数据，允许总大小为 5MB（类似于 localstorage 的存储限制），因此它们一般用作存储、同步扩展程序的设置。</p><p>当扩展程序存储的数据发生改变时，会触发 <code>onChange</code> 事件，可以对其进行监听以作出响应</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>onChanged<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">changes<span class="token punctuation">,</span> namespace</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> <span class="token punctuation">{</span> oldValue<span class="token punctuation">,</span> newValue <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>changes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Storage key &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in namespace &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; changed.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Old value was &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, new value is &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="accessibility" tabindex="-1"><a class="header-anchor" href="#accessibility" aria-hidden="true">#</a> Accessibility</h3><p>可及性，又称为 a11y，是指一系列的设计指南，以便残障人士更易于使用扩展程序，例如快捷键命令可以让视觉障碍人士更方便地使用扩展程序，字幕和翻译功能对视觉障碍人士和外语者有帮助。</p><p>开发者可以遵循以下建议，以提高扩展程序的可及性 accessible：</p><ul><li><p>使用正确的<a href="https://developer.mozilla.org/zh-CN/docs/Learn/Accessibility/HTML" target="_blank" rel="noopener noreferrer">语义化 HTML 元素</a>搭建 UI 控件，以便保障可及性。这些控件保证了可以通过键盘（Tab 键）访问操作，且它们的语义性让屏幕阅读器更容易理解。</p><p><img src="/blog-web/assets/semantic-HTML.efe1c236.png" alt="语义化 HTML 元素"></p></li><li><p>如果需要使用非语义化的 HTML 元素或 JavaScript 构建 UI 控件时，可以通过 <a href="https://www.w3.org/WAI/standards-guidelines/aria/" target="_blank" rel="noopener noreferrer">WAI-ARIA</a>，Web Accessibility Initiative - Accessible Rich Internet Applications，一个由 W3C 制定的规范，它通过给 DOM 元素添加一些规定的属性，让我们的开发的网页应用更具语义化。</p><p>💡 WAI-ARIA 属性<strong>不会</strong>对 web 页面有任何影响，只是让浏览器暴露更多的信息给无障碍 API，例如屏幕阅读器。</p><p>该规范中三个主要的特性：</p><ul><li>声明元素的角色和功能，例如 <code>role=&quot;navigation&quot;</code> 表示该元素的作用是导航</li><li>为元素定义额外的属性，例如 <code>aria-require=true</code> 告知用户该表单是必添的</li><li>设定元素的状态，例如 <code>aria-disable=&quot;true&quot;</code> 表示该表单禁止输入</li></ul><p>💡 状态和属性的差异之处就是：属性在应用的生命周期中不会改变，<strong>而状态可以</strong>，用编程的方法改变。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>toolbar<span class="token punctuation">&quot;</span></span> <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">aria-activedescendant</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>buttoncut.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cut<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>buttoncopy.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>copy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>buttonpaste.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>paste<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>以上示例中，<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/tabindex" target="_blank" rel="noopener noreferrer">属性 <code>tabindex=&quot;0&quot;</code></a> 让该元素可以聚焦，并且可以通过键盘来导航，其聚焦顺序由 DOM 结构决定；属性 <code>aria-activedescendant</code> 指定该元素聚焦时，其子代哪一个元素先进行聚焦。</p></li><li><p>元素可聚焦让用户仅通过键盘也能操作扩展程序页面，应该保证按钮、菜单栏等元素可以聚焦。默认情况下，只有锚标签、按钮、表单控件可以通过键盘聚焦，但是我们可以通过为元素添加属性 <code>tabIndex=&quot;0&quot;</code> 让任意元素可以聚焦；也可以通过添加属性 <code>tabIndex=&quot;-1&quot;</code> 让该元素无法通过键盘聚焦（但仍可以通过 JavaScript 编程聚焦 <code>elem.focus()</code>）。</p></li><li><p>与通过 Tab 键聚焦元素相比，快捷键可以让用户更方便地操作扩展程序页面的元素，可以参考<a href="https://developer.chrome.com/docs/extensions/mv3/a11y/#shortcuts" target="_blank" rel="noopener noreferrer">官方示例</a>如何用快捷键进行导航。如果在扩展程序的页面内提供了快捷键，应该在<a href="https://developer.chrome.com/docs/extensions/mv3/options/" target="_blank" rel="noopener noreferrer">设置页面 options page</a> 中告知用户。</p></li><li><p>以下设置可以完善内容的可访问性</p><ul><li><p>文本：选择合适的字体和字号大小以确保文本内容的可读性，而且应该考虑视觉障碍者的使用体验，他们可能需要设置更大的字体，避免将自定义的快捷键与页面缩放的快捷键相冲突。为了确保版型的稳定，应该测试缩放至 200%，查看页面是否还显示正常。应该避免将文字嵌入到图片中，这样不仅无法调整字体，还无法让屏幕阅读器识别；如果必须将文字嵌入图片中，应该在图片的可替代文字（属性 <code>alt</code>）中包含这些文字内容，相关指南可以参考<a href="https://webaim.org/techniques/alttext/" target="_blank" rel="noopener noreferrer">这里</a>。</p></li><li><p>颜色：背景和内容的颜色应该有足够的<strong>对比度</strong>，可以使用 <a href="https://snook.ca/technical/colour_contrast/colour.html" target="_blank" rel="noopener noreferrer">Colour Contrast Check</a> 工具检查。对于颜色丰富的图表，可以使用色弱模拟器 <a href="http://www.color-blindness.com/coblis-color-blindness-simulator/" target="_blank" rel="noopener noreferrer">Coblis</a> 来查看它在不同程度的色弱症人士眼里的效果，调整图表的配色，以使扩展程序对于这些用户更友好。可以考虑为提供不同的色彩主题，或允许自定义配色方案，以便用户有更好的体验。</p></li><li><p>声音：如果扩展程序需要声音和视频传达信息，应该提供字幕和翻译功能，关于多媒体字幕的相关指南参考<a href="https://dcmp.org/learn/213" target="_blank" rel="noopener noreferrer">这里</a>。</p></li><li><p>图片：为图片提供可替代文字，即属性 <code>alt</code>（文字内容应该用于阐明图像的目的，而不是描述图片的细节），而对于占位图和纯装饰作用的图片，应该将该属性值留空 <code>&quot;&quot;</code>，或使用 CSS 来实现（而不是用 DOM）</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>The logo for the extension<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li></ul></li><li><p>更多相关资源：</p><ul><li><a href="https://www.chromium.org/developers/design-documents/accessibility" target="_blank" rel="noopener noreferrer">Accessibility Technical Documentation</a></li><li><a href="https://youtube.com/playlist?list=PLNYkxOF6rcICWx0C9LVWWVqvHlYJyqw7g" target="_blank" rel="noopener noreferrer">A11ycasts with Rob Dodson</a></li></ul></li></ul><h3 id="internationalization" tabindex="-1"><a class="header-anchor" href="#internationalization" aria-hidden="true">#</a> Internationalization</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/i18n/" target="_blank" rel="noopener noreferrer"><code>chrome.i18n</code> API</a></li><li>关于 Internationalization 官方示例： <ul><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/i18n" target="_blank" rel="noopener noreferrer">i18n</a>（MV2 版本）</li><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/extensions/news" target="_blank" rel="noopener noreferrer">news</a>（MV2 版本）</li><li><a href="https://developer.chrome.com/docs/extensions/reference/i18n/#examples" target="_blank" rel="noopener noreferrer">Examples</a></li></ul></li></ul><p>国际化 I18N 是指在开发扩展程序时，可以让用户按需切换语言。</p><p>💡 关于软件<a href="https://zhuanlan.zhihu.com/p/112277526" target="_blank" rel="noopener noreferrer">多语言版本的开发</a>：</p><ul><li>国际化 Internationalization，L18N：软件国际化是在软件设计和文档开发过程中，使得功能和代码设计能处理多种语言和文化传统，使创建不同语言版本时，不需要重新设计源程序代码的软件工程方法。</li><li>本地化 localization ，L10N：能够使网站、Web 应用或任何其他形式的内容适用于特定语言的范围和文化圈。</li></ul><p>为了让扩展程序更方便地实现国际化，需要遵循以下建议：</p><ul><li><p>将所有用户可见的内容（文本）放在一个 <code>messages.json</code> 文档中，并将该文档放在 <code>_locales/_localeCode_</code> 相应的目录下（其中 <code>_localeCode_</code> 是一个语言编码，例如英语就应该使用 <code>en</code> 表示）。</p><p>💡 如果项目中有 <code>_locales</code> 目录，需要在配置清单 <code>manifest.json</code> 的选项 <code>default_locale</code> 中声明默认语言，可以在这里查看具体的<a href="https://developer.chrome.com/docs/webstore/i18n/#choosing-locales-to-support" target="_blank" rel="noopener noreferrer">语言代码</a>。</p><p>在 <a href="https://developer.chrome.com/docs/extensions/mv2/i18n-messages/" target="_blank" rel="noopener noreferrer"><code>messages.json</code> 文档</a>中，它以键值对的形式来定义内容，每一个键都包含一个需要国际化的项（大小写敏感），值是一个对象，其中常用的属性如下：</p><ul><li>属性 <code>message</code> 是需要显示的内容</li><li>（可选）属性 <code>description</code> 是对该项的描述，便于告知翻译者该项的意义。</li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// messages.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;search_string&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hello%20world&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The string we search for. Put %20 between words that go together.&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//  ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>💡 键名不能以 <code>@@</code> 开头，这一类的键名是<a href="https://developer.chrome.com/docs/extensions/reference/i18n/#overview-predefined" target="_blank" rel="noopener noreferrer">保留预定义的项</a>，常用的预定义 message 项如下：</p><table><thead><tr><th style="text-align:center;">Message 键名</th><th style="text-align:center;">解释</th></tr></thead><tbody><tr><td style="text-align:center;"><code>@@extension_id</code></td><td style="text-align:center;">扩展程序的 ID，对于非国际化的扩展程序该 message 项也可用，💡 但不能用于 <code>manifest.json</code> 中</td></tr><tr><td style="text-align:center;"><code>@@ui_locale</code></td><td style="text-align:center;">当前使用的语言</td></tr><tr><td style="text-align:center;"><code>@@bidi_dir</code></td><td style="text-align:center;">当前的文字方向，<code>ltr</code> 表示从左往右书写的文字，<code>rtl</code> 表示从右往左书写的文字</td></tr></tbody></table><p>例如在 CSS 中使用扩展程序中的静态图片作为背景</p><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">&#39;chrome-extension://__MSG_@@extension_id__/background.png&#39;</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>然后就可以在项目的其他文档中，通过 message 项来使用相应的数据：</p><ul><li>在 <code>manifest.json</code> 或 CSS 文档中，通过 <code>__MEG_messagename__</code> 来使用 message 相应的项 <code>messagename</code></li><li>在扩展程序页面或 JavaScript 脚本中，通过方法 <code>chrome.i18n.getMessage(&quot;messagename&quot;)</code> 获取相应的项 <code>messagename</code></li></ul><p><img src="/blog-web/assets/i18n-1.f593f5db.png" alt="i18n-1"></p><p>💡 每次新增一种语言，就需要新增一个 message 文件到 <code>_locales/_localeCode_</code> 目录里。每一种语言中，<strong>不必</strong>包含与默认语言中定义的全部 message 项。</p><p><img src="/blog-web/assets/i18n-files-structure.e842fd97.png" alt="i18n file structure"></p><p><em>以上示例是支持英语、西班牙语、韩语的扩展程序项目文件结构</em></p><p>💡 浏览器会基于用户的语言设置和扩展程序的 <code>default_locale</code> 设置来<a href="https://developer.chrome.com/docs/extensions/reference/i18n/#searching-for-messages" target="_blank" rel="noopener noreferrer">自动选择</a>采用哪一个 <code>messages.json</code> 文档</p></li></ul><h3 id="identity" tabindex="-1"><a class="header-anchor" href="#identity" aria-hidden="true">#</a> Identity</h3><p>扩展程序可以基于 <a href="https://oauth.net/2/" target="_blank" rel="noopener noreferrer">OAuth 2.0</a> 获取授权，访问 Chrome 用户信息，具体参考 <a href="https://developer.chrome.com/docs/extensions/reference/identity/" target="_blank" rel="noopener noreferrer"><code>chrome.identity</code> API</a>。</p><p>💡 关于该授权机制的介绍可以参考<a href="https://www.ruanyifeng.com/blog/2019/04/oauth_design.html" target="_blank" rel="noopener noreferrer">这里</a>。</p><h3 id="management" tabindex="-1"><a class="header-anchor" href="#management" aria-hidden="true">#</a> Management</h3><p>管理已安装和正在运行的扩展程序，具体参考 <a href="https://developer.chrome.com/docs/extensions/reference/management/" target="_blank" rel="noopener noreferrer"><code>chrome.management</code> API</a>。</p><h2 id="用户交互" tabindex="-1"><a class="header-anchor" href="#用户交互" aria-hidden="true">#</a> 用户交互</h2><h3 id="action" tabindex="-1"><a class="header-anchor" href="#action" aria-hidden="true">#</a> Action</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/action/" target="_blank" rel="noopener noreferrer"><code>chrome.action</code> API</a></li><li>关于 Action 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/api/action" target="_blank" rel="noopener noreferrer">官方示例</a></li></ul><p><img src="/blog-web/assets/UI-Action.70914301.png" alt="图标"></p><p>该交互控件是指在浏览器工具栏的扩展程序<strong>图标</strong>，供用户点击，可以执行预定的操作。它也可以作为唤起其他交互控件的入口，例如通过适当的配置，在悬停时可以显示<strong>提示框 tooltip</strong>，在点击时可以弹出<strong>弹出框 popup</strong>。</p><p>💡 安装扩展程序后，Action 图标默认「隐藏」在浏览器工具栏的扩展程序（拼图）图标下，可以将它 pin 到工具栏上。</p><p>💡 在 MV2 版本中有 <a href="https://developer.chrome.com/docs/extensions/reference/browserAction/" target="_blank" rel="noopener noreferrer">API <code>chrome.browserAction</code></a>（浏览器级别的按钮，对所有页面都可以响应）和 <a href="https://developer.chrome.com/docs/extensions/reference/pageAction/" target="_blank" rel="noopener noreferrer">API <code>chrome.pageAction</code></a>（针对特定匹配条件的页面才会响应）；而在 <strong>MV3 版本</strong>中新增了 <a href="https://developer.chrome.com/docs/extensions/reference/action/" target="_blank" rel="noopener noreferrer"><code>chorme.action</code> API</a>，它的功能有点像是 MV2 的 Browser Action，可以在大部分的页面响应用户点击，如果希望实现类似于 Page Action 的功能<strong>只在特定的页面响应点击</strong>，可以参考<a href="https://developer.chrome.com/docs/extensions/reference/action/#emulating-pageactions-with-declarativecontent" target="_blank" rel="noopener noreferrer">官方示例</a>，先使用 <code>chrome.action.disable()</code> 将 Action 图标设置为默认不响应点击，再使用方法 <code>new chrome.declarativeContent.PageStateMatcher()</code> 设置当 Page URL 匹配时才让 Action 图标响应点击。</p><ul><li><p>如果要使用该控件，需要先在配置清单 <code>manifest.json</code> 的选项 <code>action</code> 中进行声明注册，例如指定图标文件的相对路径，如果使用了 popup 要指定弹出框的 HTML 文件。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 图标文件</span>
    <span class="token property">&quot;default_icon&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>              <span class="token comment">// optional</span>
      <span class="token property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;images/icon16.png&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// optional</span>
      <span class="token property">&quot;24&quot;</span><span class="token operator">:</span> <span class="token string">&quot;images/icon24.png&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// optional</span>
      <span class="token property">&quot;32&quot;</span><span class="token operator">:</span> <span class="token string">&quot;images/icon32.png&quot;</span>    <span class="token comment">// optional</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 提示框</span>
    <span class="token property">&quot;default_title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Click Me&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// optional, shown in tooltip</span>
    <span class="token comment">// 弹出框</span>
    <span class="token property">&quot;default_popup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;popup.html&quot;</span>  <span class="token comment">// optional</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>💡 即使扩展程序的配置清单中没有设置 <code>action</code> 选项，它也可以显示在浏览器工具栏上，会使用一个默认图标，一般以背景色为灰底且包含扩展程序的首字母的图标指代。</p></li><li><p>图标</p><p>icon 图标的默认高和宽都是 16 DIPs（device-independent pixels），推荐预设多个尺寸的图标，浏览器会使用恰当的文件。图标文件的格式需要是 <a href="https://en.wikipedia.org/wiki/Blink_(browser_engine)" target="_blank" rel="noopener noreferrer">Blink 渲染引擎</a>所支持的，例如 PNG、JPEG、BMP、ICO 等，<mark>而 SVG 是<strong>不</strong>支持的</mark>。如果是解压的扩展程序，则只支持 PNG 格式。</p><table><thead><tr><th style="text-align:center;">图标尺寸</th><th style="text-align:center;">用途</th></tr></thead><tbody><tr><td style="text-align:center;">16x16</td><td style="text-align:center;">作为扩展程序的相关页面的 favicon</td></tr><tr><td style="text-align:center;">32x32</td><td style="text-align:center;">一般 Windows 系统使用该尺寸</td></tr><tr><td style="text-align:center;">48x48</td><td style="text-align:center;">在扩展程序管理页面中显示</td></tr><tr><td style="text-align:center;">128x128</td><td style="text-align:center;">在 Chrome 网上应用店显示</td></tr></tbody></table><p>除了在配置清单 <code>manifest.json</code> 的选项 <code>action.default_icon</code> 中提供固定的文件，还有通过编程的方式，使用方法 <code>chrome.action.setIcon()</code> 设置图标，可以根据条件设置不同的图片路径，也可以使用 canvas 创建图片。⚠️ 该方法是用于设置静态图片，而不应该用于设置动图。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OffscreenCanvas</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&#39;#00FF00&#39;</span><span class="token punctuation">;</span>  <span class="token comment">// Green</span>
context<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> imageData <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token punctuation">{</span>imageData<span class="token operator">:</span> imageData<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p>提示框</p><p>tooltip 是在用户悬停在图标时显示的提示框，可以设置一段简短的文字，用以提示该扩展程序的名称。</p><p>除了在配置清单 <code>manifest.json</code> 的选项 <code>action.default_title</code> 中设置文字，还可以使用方法 <code>chrome.action.setTitle()</code> 进行设置。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">&#39;this is tooltip content&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>💡 当图标按钮被聚焦时，它可以被<strong>屏幕阅读软件</strong>识别，可以增强扩展程序的可及性。</p></li><li><p>弹出框</p><p>popup 是在用户点击 Action 图标时显示的弹出框，它实际上是一个<a href="https://developer.chrome.com/docs/extensions/reference/action/#popup" target="_blank" rel="noopener noreferrer">大小</a>受到<a href="https://stackoverflow.com/questions/8983165/how-can-i-expand-the-popup-window-of-my-chrome-extension" target="_blank" rel="noopener noreferrer">限制</a>（高和宽的最小值是 25px，高的最大值是 600px，宽的最大值是 800px）的 HTML 页面，默认大小是基于内容的。</p><p>除了在配置清单 <code>manifest.json</code> 的选项 <code>action.default_popup</code> 中设置 popup 页面，还可以<strong>使用方法 <code>chrome.action.setPopup()</code> 动态更新弹出框所指向的 HTML 文件的路径</strong>。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;signed_in&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>signed_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setPopup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>popup<span class="token operator">:</span> <span class="token string">&#39;popup.html&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setPopup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>popup<span class="token operator">:</span> <span class="token string">&#39;popup_sign_in.html&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>💡 它和普通的 HTML 文档一样，可以引入样式文件和脚本文件，但<strong>不</strong>支持使用行内脚本 inline JavaScript</p></li><li><p>标记</p><p>badge 是一个添加到图标上的文字，并允许设置背景色，一般用以显示扩展程序的状态，例如更新了新版本可以显示 <code>new</code>，如果扩展程序带统计功能则可以形式数值等。</p><p>💡 由于 badge 需要添加到图标上，所以在设置 badge 前，扩展程序需要先在配置清单 <code>manifest.json</code> 的选项 <code>action</code> 中设置图标</p><p>⚠️ 由于标记的空间有限，所以一般<strong>只能显示 4 个或以下的字符</strong></p><p>通过方法 <code>chrome.action.setBadgeText()</code> 设置标记文字；通过<code>chrome.action.setBadgeBackgroundColor()</code> 设置标记的背景色</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 设置 badge 文字内容</span>
chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setBadgeText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>text<span class="token operator">:</span> <span class="token string">&#39;NEW&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过多种方式设置 badge 背景颜色</span>
chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setBadgeBackgroundColor</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">// Green</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setBadgeBackgroundColor</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">&#39;#00FF00&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// Also green</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setBadgeBackgroundColor</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">&#39;green&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">// Also, also green</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li><li><p><strong>action 在每一个标签页都可以有不同的状态</strong>，例如可以针对不同的标签页，设置不同 badge 内容</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getTabId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getTabBadge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span><span class="token punctuation">}</span>

chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">setBadgeText</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    text<span class="token operator">:</span> <span class="token function">getTabBadge</span><span class="token punctuation">(</span>tabId<span class="token punctuation">)</span><span class="token punctuation">,</span>
    tabId<span class="token operator">:</span> <span class="token function">getTabId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>💡 如果方法 <code>setBadgeText</code> 第一个参数的选项 <code>tabId</code> 省略了，则该标记会作为全局设置，而提供了 <code>tabId</code> 则针对特定的标签页，优先级更高，会覆盖全局设置的标记文字。</p></li><li><p>默认所有标签页下，action 图标都是<strong>可以响应点击的 clickable</strong>，可以通过方法 <code>chrome.action.enable()</code> 或 <code>chrome.action.disable()</code> 来手动控制 action 的响应状态，这会影响 popup 的显示或 <code>chrome.action.onClicked</code> 所监听的相应事件的分发。</p></li></ul><h3 id="context-menu" tabindex="-1"><a class="header-anchor" href="#context-menu" aria-hidden="true">#</a> Context Menu</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/contextMenus/" target="_blank" rel="noopener noreferrer"><code>chrome.contextMenus</code> API</a></li><li>关于 Context Menu <a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/apps/samples/context-menu" target="_blank" rel="noopener noreferrer">官方示例</a></li></ul><p><img src="/blog-web/assets/UI-Context-Menu.aaaf12f0.png" alt="菜单选项"></p><p>该交互控件是指浏览器的<strong>右键菜单</strong>，可以通过扩展程序往其中添加选项，除了可以针对整个页面，还可以针对特定的 DOM 元素，或 action 图标，添加右键菜单项。</p><ul><li><p>如果要使用该控件，需要先在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中进行声明注册。为了便于将菜单选项与扩展程序相匹配，需要在配置清单的选项 <code>icons</code> 中指定图标文件，最好提供多种尺寸的图片文件。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;contextMenus&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon-bitty.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon-small.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon-large.png&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li><li><p>使用方法 <code>chrome.contextMenus.create({}, callback())</code> 为扩展程序创建专属的菜单项，它可以接收两个入参，第一个参数是配置对象，第二个参数是回调函数。返回值该菜单选项的唯一 ID 值。</p><p>配置对象有多个选项，常用如下：</p><ul><li><p><code>id</code> 为当前菜单选项分配一个唯一 ID</p></li><li><p><code>title</code>（<strong>必须</strong>，除非该菜单选项的类型是分割线 <code>type: &quot;separator&quot;</code>）菜单选项的内容</p></li><li><p><code>type</code> 菜单选项的类型，默认值是 <code>normal</code>，就是正常的菜单选项，还可以是 <code>checkbox</code>、<code>radio</code>、<code>separator</code></p></li><li><p><code>contexts</code> 数组，限制菜单选项出现在<a href="https://developer.chrome.com/docs/extensions/reference/contextMenus/#type-ContextType" target="_blank" rel="noopener noreferrer">对页面的哪个元素</a>进行右键点击时，默认值是 <code>[&#39;page&#39;]</code>，即在整个网页任何地方右键点击时，该菜单选项都显示在菜单中</p></li><li><p><code>parentId</code> 当前菜单选项的父级菜单的 ID</p></li><li><p><code>onclick</code> 监听菜单选项的点击事件和事件处理函数，当菜单选项被点击时执行该事件处理函数，会有两个入参 <code>info</code>（该菜单选项的信息）和 <code>tab</code>（当前标签页的信息）传入</p></li></ul><p>（可选）回到函数是在用户右键点击，该菜单选项被创建时所执行的</p><p>该方法应该在<strong>后台脚本</strong>中设置，并在安装扩展程序完成时的钩子函数 <code>chroe.runtime.onInstalled.addListener()</code> 中调用，以便安装完成时，右键菜单选项即可用</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> key<span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token string">&#39;context menu demo&#39;</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">&#39;normal&#39;</span><span class="token punctuation">,</span>
    contexts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;selection&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li><li><p>使用方法 <code>chrome.contextMenus.update(menuItemId, {}, callback())</code> 更新给定菜单选项，第一个参数是菜单选项的唯一 ID 值，第二个参数是配置对象（和方法 <code>chrome.contextMenus.create()</code> 的配置对象可使用的选项一样），第三个（可选）参数是回调函数，在更新完菜单选项后执行。</p></li></ul><p>💡 浏览器的右键菜单是全局的，可以出现在任何页面中，甚至是 <code>file://</code> 或 <code>chrome://URLs</code> 的页面，如果希望控制菜单选项出现在指定的页面，你可以在创建 <code>create()</code> 或更新 <code>update()</code> 菜单选项时，通过配置对象的选项 <code>documentUrlPatterns</code> 来限制只能在<a href="https://developer.chrome.com/docs/extensions/mv3/match_patterns/" target="_blank" rel="noopener noreferrer">特定的 URL</a> 页面或 <code>&lt;iframe&gt;</code> 中，右键点击才显示相应的菜单项。</p><ul><li><p>使用方法 <code>chrome.contextMenus.remove(menuItemId, callback())</code> 动态删除已创建的菜单选项。（可选）回调函数在删除指定的菜单选项后执行。如果想删除所有该扩展程序创建的菜单选项，可以使用方法 <code>chrome.contextMenus.removeAll(callback())</code> 其（可选）回调函数会在删除菜单选项后执行。</p></li><li><p>可以创建多个菜单选项，但是如果选项多于一个，浏览器会自动将它们收纳到一个<strong>次级菜单</strong>中</p></li><li><p>使用方法 <code>chrome.contextMenus.onClicked(callback())</code> 监听该扩展程序菜单选项的点击事件，并执行相应的事件处理函数，该函数接收两个入参 <code>info</code> 被点击的菜单选项的相关信息，<code>tab</code> 标签页相关信息。</p></li></ul><h3 id="omnibox" tabindex="-1"><a class="header-anchor" href="#omnibox" aria-hidden="true">#</a> Omnibox</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/omnibox/" target="_blank" rel="noopener noreferrer"><code>chrome.omnibox</code> API</a></li><li>关于 Omnibox 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/api/omnibox/new-tab-search" target="_blank" rel="noopener noreferrer">官方示例</a></li></ul><p><img src="/blog-web/assets/UI-Omnibox.09dd1984.png" alt="Omnibox"></p><p>该交互控件是指地址栏上的<strong>搜索关键词</strong>，当用户在地址栏输入相应的关键词，就会触发 Omnibox（唤起相应的扩展程序），接下来用户在地址栏中输入内容是直接与该扩展程序进行交互。一般会在扩展程序中预先设置一系列的搜索建议，当用户输入的内容模糊匹配成功时，就会在一个 dropdown 中显示相应的搜索建议。</p><ul><li><p>如果要使用该控件，需要先在配置清单 <code>manifest.json</code> 的选项 <code>omnibox</code> 中进行声明注册。当 Omnibox 被触发时，扩展程序图标（以灰阶的形式展示）和名称会显示在地址栏的左侧，为了便于识别，需要在配置清单的选项 <code>icons</code> 中指定图标文件，最好提供多种尺寸的图片文件（默认使用高和宽为 16px 的图标）。</p><p>该控件的交互逻辑在<strong>后台脚本</strong>的 service worker 中设置（需要在配置清单 <code>manifest.json</code> 的选项 <code>background.service_worker</code> 中声明注册），基于事件监听-响应的原理。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;service_worker&quot;</span><span class="token operator">:</span> <span class="token string">&quot;background.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;omnibox&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;keyword&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon-bitty.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon-small.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon-large.png&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>以上示例将扩展程序的 Omnibox 触发关键词设定为 <code>demo</code>，当用户在地址栏输入 demo 时，会在下拉框显示一个扩展程序名称的选项，可以点击该选项，或按 Tab 键，或键入空格 Space，即可触发 Omnibox。</p><p><img src="/blog-web/assets/UI-Omnibox-trigger.d0c5de0c.png" alt="Omnibox 触发"></p></li><li><p>常用于监听事件的 API 如下：</p><ul><li><p><code>onInputChanged</code> 进入 Omnibox 模式后，当用户在地址栏中输入内容时会触发。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>omnibox<span class="token punctuation">.</span>onInputChanged<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> suggest</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>text<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token function">suggest</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
          content<span class="token operator">:</span> text<span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">search for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>事件处理函数中接收两个入参，第一个参数 <code>text</code> 是用户输入的内容（字符串），第二个参数 <code>suggest</code> 是一个方法，它接收一个数组，包含一系列的建议结果 SuggestResult，该方法会将这些建议选项传递回浏览器，显示在地址栏的下拉框中。</p><p>💡 建议结果 SuggestResult 是一个对象，以供用户选择，包括以下属性：</p><ul><li><code>content</code> 实际上会输入到地址栏的内容，当用户选中该建议选项时，会传递给扩展程序的内容</li><li><code>deletable</code> 该建议选项是否可以让用户删除</li><li><code>description</code> 描述内容，显示在地址栏的下拉框中，可以包含 XML 风格的样式修饰。但是不能包含 5 种 <a href="https://stackoverflow.com/questions/1091945/what-characters-do-i-need-to-escape-in-xml-documents/1091953#1091953" target="_blank" rel="noopener noreferrer">XML 转义字符</a>。</li></ul><p>💡 可以使用方法 <code>chrome.omnibox.setDefaultSuggestion(suggestion)</code> 设置默认的建议选项，该方法接收的入参是一个不完整 suggestionResult 对象，<strong>没有 <code>content</code> 属性</strong>，其作用类似于输入框中的 placeholder。当触发了 Omnibox 时，在用户还没输入内容时，该默认建议就会出现在地址栏的下拉框中第一条的位置。</p><p><mark>⚠️ 根据一个 <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1186804" target="_blank" rel="noopener noreferrer">Bug 报告</a>，由于 Omnibox 的搜索建议内容支持 XML，所以需要调用 DomParser，但是后台脚本在 MV3 版本迁移改用了 service worker，该运行环境并没有 DomParser，所以会导致报错，且无法正常显示搜索建议选项。</mark></p></li><li><p><code>onInputEntered</code> 在用户选择执行一个建议选项后，触发回调函数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>omnibox<span class="token punctuation">.</span>onInputEntered<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> disposition</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>text<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;inputEntered: &#39;</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Encode user input for special characters , / ? : @ &amp; = + $ #</span>
  <span class="token keyword">var</span> newURL <span class="token operator">=</span> <span class="token string">&#39;https://www.google.com/search?q=&#39;</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token operator">:</span> newURL <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>disposition<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>事件处理函数接收两个参数，第一个参数 <code>text</code> 是输入到地址栏的内容，第二个参数 <code>disposition</code> 是进行搜寻时窗口的设置，有三种可能的结果：</p><ul><li><p><code>currentTab</code> 在当前标签页进行搜寻</p></li><li><p><code>newForegroundTab</code> 新建一个标签页进行搜寻，同时切换到该标签页</p></li><li><p><code>newBackgroundTab</code> 新建一个标签页进行搜寻，但不进行标签页的切换</p></li></ul><p>以上示例调用了 <code>chrome.tabs.create()</code> 方法，在当前标签页进行搜索，所以终端打印的值是 <code>currentTab</code></p></li></ul></li></ul><h3 id="override-pages" tabindex="-1"><a class="header-anchor" href="#override-pages" aria-hidden="true">#</a> Override Pages</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/mv3/override/" target="_blank" rel="noopener noreferrer">Overriding Chrome pages</a></li><li>关于 Override Pages 的官方示例 <ul><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/history/historyOverride" target="_blank" rel="noopener noreferrer">historyOverride</a>（MV2 版本）</li><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/override/blank_ntp" target="_blank" rel="noopener noreferrer">blank_ntp</a>（MV2 版本）</li><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/override/override_igoogle" target="_blank" rel="noopener noreferrer">override_igoogle</a>（MV2 版本）</li></ul></li></ul><p><img src="/blog-web/assets/UI-Override-Page-NewTab.e4cb0143.png" alt="覆写新建标签页"></p><p>该交互控件是通过<strong>覆写页面</strong>实现的，扩展程序可以覆写三个 Chrome 的特殊页面：</p><ul><li>Bookmark Manager：书签管理页面 <code>chrome://bookmarks</code></li><li>History：历史记录页面 <code>chrome://history</code></li><li>New Tab：新建标签页 <code>chrome://newtab</code></li></ul><p>💡 每一个扩展程序<strong>只能覆写以上三个特殊 Chrome 页面之</strong>，而每一种特殊 Chrome 页面，只能选择被一个扩展程序进行覆写。此外隐身模式下，新建标签页不能被覆写。</p><ul><li><p>如果要使用该控件，需要先在配置清单 <code>manifest.json</code> 的选项 <code>chrome_url_overrides</code> 中进行声明注册，将需要覆写的页面作为属性，<code>bookmarks</code>、<code>history</code>、<code>newtab</code> 三者之一，属性值就是用以替换的 HTML 页面文档的相对路径。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;chrome_url_overrides&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;newTab&quot;</span><span class="token operator">:</span> <span class="token string">&quot;newPage.html&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p>为了提供更好的用户体验，用以替换的页面应该遵循以下指引：</p><ul><li>页面文件大小应该较小，便于快速加载显示，避免使用同步访问网络或数据库资源，导致渲染阻塞。</li><li>包含明确的信息，告知用户当前浏览的是 Chrome 的特殊页面。</li><li>不要在新建标签页使用输入框聚焦功能，因为新建页面时，标签页的地址栏会首先获取焦点。</li></ul></li></ul><p>💡 用以替换的页面可以引入样式文件或脚本文件，但<strong>不</strong>支持行内脚本 inline JavaScript</p><h3 id="commands" tabindex="-1"><a class="header-anchor" href="#commands" aria-hidden="true">#</a> Commands</h3><p>参考：</p><ul><li><p><a href="https://developer.chrome.com/docs/extensions/reference/commands/" target="_blank" rel="noopener noreferrer"><code>chrome.commands</code> API</a></p></li><li><p>关于 Commands 的<a href="https://developer.chrome.com/docs/extensions/reference/commands/#examples" target="_blank" rel="noopener noreferrer">官方示例</a></p></li></ul><p>该交互控件是指使用<strong>快捷键</strong>操作扩展程序，可以通过快捷键激活 action 或执行特定的命令。</p><p>💡 所有扩展程序的快捷键都在 <code>chrome://extensions/shortcuts</code> 中显示，<strong>用户可以在其中修改快捷键的组合值，或快捷键的局部与全局适用性</strong>。</p><p><img src="/blog-web/assets/UI-Commands-Shortcuts-Setting.644ac56c.png" alt="修改扩展程序快捷键"></p><ul><li><p>如果要使用该控件，需要先将这些快捷键在配置清单 <code>manifest.json</code> 的选项 <code>commands</code> 中进行声明注册，该选项的值是一个对象，属性名是一个描述命令的名称，属性值是关于快捷键定义的对象，一般有两个选项：</p><ul><li><code>suggested_key</code>（可选）声明默认的快捷键，其值可以是一个表示（跨平台适用的）快捷键的字符串，或是一个对象，可以<strong>针对不同的系统平台</strong>设定不同的快捷键，其中系统平台支持 <code>default</code>、<code>chromeos</code>、<code>linus</code>、<code>mac</code>、<code>windows</code>。如果该选项<strong>省略</strong>，则该命令没有相应的触发快捷键，<strong>等待用户来设定后再生效</strong>。</li><li><code>description</code> 一段告知用户该快捷键功能作用的字符串，它会显示在扩展程序的快捷键管理界面中 <code>chrome://extensions/shortcuts</code>，对于标准快捷键 standard commands 它是必须的，对于 action commands 是可选的。</li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;commands&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;run-foo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;suggested_key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ctrl+Shift+Y&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mac&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Command+Shift+Y&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Run \&quot;foo\&quot; on the current page.&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_execute_action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;suggested_key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;windows&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ctrl+Shift+Y&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mac&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Command+Shift+Y&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;chromeos&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ctrl+Shift+U&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;linux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ctrl+Shift+J&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>💡 其中 <code>_execute_action</code> 是保留属性，用以定义<strong>激活 action 的快捷键</strong>（对于 MV2 版本，则有 <code>_execute_browser_action</code> 和 <code>_execute_page_action</code> 保留属性，分别设定激活 browser action 和 page action 的快捷键），对于激活 action 的快捷键<em>无法**触</em>发 <code>command.onCommand</code> 事件。</p><p>然后在<strong>后台脚本</strong>中使用 <code>chrome.commands.onCommand.addListener()</code> API 监听快捷键命令触发事件</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Tab Flipper&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;commands&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;flip-tabs-forward&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;suggested_key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ctrl+Shift+Right&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mac&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Command+Shift+Right&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Flip tabs forward&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;flip-tabs-backwards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;suggested_key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ctrl+Shift+Left&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mac&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Command+Shift+Left&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Flip tabs backwards&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>commands<span class="token punctuation">.</span>onCommand<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">command</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果用户触发了扩展程序注册的快捷键，则传入的参数 command 是命令的名称</span>
  <span class="token comment">// command will be &quot;flip-tabs-forward&quot; or &quot;flip-tabs-backwards&quot;</span>

  chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>currentWindow<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">tabs</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Sort tabs according to their index in the window.</span>
    tabs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>index <span class="token operator">-</span> b<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> activeIndex <span class="token operator">=</span> tabs<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> tab<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lastTab <span class="token operator">=</span> tabs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">===</span> <span class="token string">&#39;flip-tabs-forward&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newIndex <span class="token operator">=</span> activeIndex <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> lastTab <span class="token operator">:</span> activeIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// &#39;flip-tabs-backwards&#39;</span>
      newIndex <span class="token operator">=</span> activeIndex <span class="token operator">===</span> lastTab <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> activeIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tabs<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>active<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> highlighted<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>💡 当新安装的扩展程序的快捷键默认值，与已安装的其他扩展程序的快捷键冲突时，对于后来安装的扩展程序，浏览器就不会再注册这些快捷键，避免覆盖之前已存在的快捷键。为了避免让用户觉得快捷键「无故失灵」的现象，我们应该采用以下更健壮的方法，在安装扩展程序时 <code>chrome.runtime.onInstalled.addListener</code> 先进行检查快捷键冲突，并告知用户</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>

<span class="token comment">// Only use this function during the initial install phase. After</span>
<span class="token comment">// installation the user may have intentionally unassigned commands.</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">===</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>OnInstalledReason<span class="token punctuation">.</span><span class="token constant">INSTALL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkCommandShortcuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">checkCommandShortcuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取当前插件已注册的快捷键</span>
  chrome<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">commands</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> missingShortcuts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span> shortcut<span class="token punctuation">}</span> <span class="token keyword">of</span> commands<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果冲突无法注册快捷键默认值，则 shortcut 值为空字符串</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shortcut <span class="token operator">===</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        missingShortcuts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果该扩展程序与其他扩展程序真的存在快捷键冲突</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>missingShortcuts<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Update the extension UI to inform the user that one or more</span>
      <span class="token comment">// commands are currently unassigned.</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div></li><li><p>快捷键<strong>必须包含 <code>Ctrl</code> 或 <code>Alt</code> 两者之一</strong>，对<strong>大小写敏感</strong>，支持使用以下按键组合为快捷键：</p><ul><li>字母键 <code>A-Z</code></li><li>数字键 <code>0~9</code></li><li>标准的功能键 <ul><li>通用键 <code>Comma</code>, <code>Period</code>, <code>Home</code>, <code>End</code>, <code>PageUp</code>, <code>PageDown</code>, <code>Space</code>, <code>Insert</code>, <code>Delete</code></li><li>方向键 <code>Up</code>, <code>Down</code>, <code>Left</code>, <code>Right</code></li></ul></li><li>修饰键 <code>Ctrl</code>, <code>Alt</code>, <code>Shift</code>, <code>MacCtrl</code> (macOS only), <code>Command</code> (macOS only), <code>Search</code> (Chrome OS only)</li></ul><p>💡 不支持 <code>Tab</code> 键，媒体键<strong>不</strong>能与修饰键组合。</p></li><li><p>为了响应快捷键，需要在<strong>后台脚本</strong>中使用 <code>chrome.commands.onCommand.addListener</code> API 进行监听</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>commands<span class="token punctuation">.</span>onCommand<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">command</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Command: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>command<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>💡 和标准的快捷键 standard commands 不同，对于激活 action 的快捷键，<strong>无法</strong>通过以上方法进行监听。可以在弹出框 popup 的脚本文件中，监听 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/DOMContentLoaded_event" target="_blank" rel="noopener noreferrer"><code>DOMContentLoaded</code> 事件</a>来替代。</p></li><li><p>默认情况下，注册的快捷键是 Chrome 浏览器的局部快捷键（当浏览器是当前系统的激活应用时，按下快捷键，扩展程序才响应），也可以在快捷键定义对象中，通过选项 <code>global: true</code> 设定为全局快捷键。<strong>建议注册全局快捷键限制在 <code>Ctrl+Shift+[0..9]</code> 范围中</strong>，以避免覆盖掉其他系统级别的快捷键。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;commands&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;toggle-feature-foo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;suggested_key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ctrl+Shift+5&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Toggle feature foo&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>💡 但是 Chrome OS 不支持扩展程序设定全局快捷键</p></li></ul><h2 id="定制浏览器体验" tabindex="-1"><a class="header-anchor" href="#定制浏览器体验" aria-hidden="true">#</a> 定制浏览器体验</h2><p>扩展程序可以使用很多相关的 API 以定制浏览器体验：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/bookmarks/" target="_blank" rel="noopener noreferrer">Bookmarks</a> 书签管理</li><li><a href="https://developer.chrome.com/docs/extensions/reference/browsingData/" target="_blank" rel="noopener noreferrer">Browsing Data</a> 用户浏览数据</li><li><a href="https://developer.chrome.com/docs/extensions/reference/downloads/" target="_blank" rel="noopener noreferrer">Downloads</a> 下载项管理</li><li><a href="https://developer.chrome.com/docs/extensions/reference/fontSettings/" target="_blank" rel="noopener noreferrer">Font Settings</a> 字体设置</li><li><a href="https://developer.chrome.com/docs/extensions/reference/history/" target="_blank" rel="noopener noreferrer">History</a> 浏览历史记录</li><li><a href="https://developer.chrome.com/docs/extensions/reference/privacy/" target="_blank" rel="noopener noreferrer">Privacy</a> 隐私权限设置</li><li><a href="https://developer.chrome.com/docs/extensions/reference/proxy/" target="_blank" rel="noopener noreferrer">Proxy</a> 代理设置</li><li><a href="https://developer.chrome.com/docs/extensions/reference/sessions/" target="_blank" rel="noopener noreferrer">Sessions</a> 从浏览会话中查询和恢复标签页或窗口</li><li><a href="https://developer.chrome.com/docs/extensions/reference/tabs/" target="_blank" rel="noopener noreferrer">Tabs</a> 创建、修改、重排标签页</li><li><a href="https://developer.chrome.com/docs/extensions/reference/topSites/" target="_blank" rel="noopener noreferrer">Top Sites</a> 访问用户最常浏览的网页</li><li><a href="https://developer.chrome.com/docs/extensions/mv3/themes/" target="_blank" rel="noopener noreferrer">Themes</a> 改变浏览器外观与主题</li><li><a href="https://developer.chrome.com/docs/extensions/reference/windows/" target="_blank" rel="noopener noreferrer">Windows</a> 创建、修改、重排浏览器窗口</li></ul><h3 id="bookmarks" tabindex="-1"><a class="header-anchor" href="#bookmarks" aria-hidden="true">#</a> Bookmarks</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/bookmarks/" target="_blank" rel="noopener noreferrer"><code>Chrome.bookmarks</code> API</a></li><li>关于 Bookmarks 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/api/action" target="_blank" rel="noopener noreferrer">官方示例</a><ul><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/bookmarks/basic" target="_blank" rel="noopener noreferrer">bookmarks basic</a>（MV2 版本）</li><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/examples/bookmarks" target="_blank" rel="noopener noreferrer">bookmarks</a></li></ul></li></ul><p>可以使用扩展程序定制浏览器的书签管理行为。除了可以使用<a href="https://developer.chrome.com/docs/extensions/mv3/override/" target="_blank" rel="noopener noreferrer">覆写页面 Override Page</a> 的方式<strong>定制书签管理页面</strong>，还可以使用 <code>Chrome.bookmarks</code> 一些列 API 操作书签。</p><p>如果要使用 <code>Chrome.bookmarks</code> API，需要先在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中进行权限声明注册</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bookmarks&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>书签数据是以<strong>树形</strong>结构组织的，每一个<a href="https://developer.chrome.com/docs/extensions/reference/bookmarks/#type-BookmarkTreeNode" target="_blank" rel="noopener noreferrer">节点对象 <code>bookmarks.BookmarkTreeNode</code></a> 是一个书签或一个文件夹（也称为组），它具有多种<a href="https://developer.chrome.com/docs/extensions/reference/bookmarks/#type-BookmarkTreeNode" target="_blank" rel="noopener noreferrer">属性</a>，以下列出常用的几个：</p><ul><li><code>children</code> 子节点列表</li><li><code>id</code> （必须）唯一标识符</li><li><code>index</code> 在父级文件夹中的索引（从 <code>0</code> 开始）</li><li><code>parentId</code> 父级文件夹的唯一标识符（<strong>根节点</strong>省略该属性）</li><li><code>title</code> （必须）节点所展示的名称</li><li><code>url</code> 书签的链接，文件夹可以省略该属性</li></ul><p>⚠️ 根节点是一个文件夹，不能删除，且只能有一个。 而且不能重命名特殊的节点（文件夹）📁 书签栏 <code>Bookmarks Bar</code> 和 📁 其他书签 <code>Other Bookmarks</code></p><p>使用方法 <code>chrome.bookmarks.create()</code> 创建一个书签节点，接收两个入参，第一个是节点的属性，第二个（可选）参数是回调函数</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 创建一个文件夹，名为 Extension bookmarks</span>
chrome<span class="token punctuation">.</span>bookmarks<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span><span class="token string">&#39;parentId&#39;</span><span class="token operator">:</span> bookmarkBar<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">&#39;title&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Extension bookmarks&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newFolder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;added folder: &quot;</span> <span class="token operator">+</span> newFolder<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个书签，名为 Extensions doc，链接为 https://developer.chrome.com/docs/extensions</span>
chrome<span class="token punctuation">.</span>bookmarks<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&#39;parentId&#39;</span><span class="token operator">:</span> extensionsFolderId<span class="token punctuation">,</span>
  <span class="token string">&#39;title&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Extensions doc&#39;</span><span class="token punctuation">,</span>
  <span class="token string">&#39;url&#39;</span><span class="token operator">:</span> <span class="token string">&#39;https://developer.chrome.com/docs/extensions&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="browsing-data" tabindex="-1"><a class="header-anchor" href="#browsing-data" aria-hidden="true">#</a> Browsing Data</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/browsingData/" target="_blank" rel="noopener noreferrer"><code>chrome.browsingData</code> API</a></li><li>关于 Browsing Data 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/browsingData/basic" target="_blank" rel="noopener noreferrer">官方示例</a>（MV2 版本）</li></ul><p>扩展程序可以删除特定时间段的用户浏览数据。</p><p>如果要使用 <code>Chrome.bookmarks</code> API，需要先在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中进行权限声明注册</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;browsingData&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用方法 <code>chrome.browsingData.remove()</code> 删除用户浏览数据。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 删除一周以来的数据</span>
<span class="token keyword">const</span> millisecondsPerWeek <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> oneWeekAgo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> millisecondsPerWeek<span class="token punctuation">;</span>

<span class="token comment">// 删除所有用户操作数据</span>
chrome<span class="token punctuation">.</span>browsingData<span class="token punctuation">.</span><span class="token function">removeCookies</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;since&quot;</span><span class="token operator">:</span> oneWeekAgo
<span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Do something clever here once data has been removed.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>💡 删除用户数据可能需要较长的时间（基于用户产生了多少操作历史数据），因此推荐设置回调函数（它在清除完成后执行），以告知用户最新的状态。</p><p>⚠️ 方法 <code>chrome.browsingData.remove()</code> 可能在清除完 cookie 后自动设置它们，以便让账户的数据同步功能正常运作，这样才可以让服务器中已同步的相应数据也覆盖清除掉；而使用<a href="https://developer.chrome.com/docs/extensions/reference/browsingData/#method-removeCookies" target="_blank" rel="noopener noreferrer">方法 <code>chrome.browsingData.removeCookies</code></a> 清除 cookie 时，会停止同步功能。</p><p>💡 可以传递一个 JSON 形式的对象，指定需要删除哪几种浏览器数据，也可以调用<a href="https://developer.chrome.com/docs/extensions/reference/browsingData/#methods" target="_blank" rel="noopener noreferrer">对应的方法</a>来删除相应类型的用户数据。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 删除指定的用户操作数据</span>
chrome<span class="token punctuation">.</span>browsingData<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;since&quot;</span><span class="token operator">:</span> oneWeekAgo
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;appcache&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cache&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cacheStorage&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cookies&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;downloads&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;fileSystems&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;formData&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;history&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;indexedDB&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;localStorage&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;passwords&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;serviceWorkers&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;webSQL&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>💡 还可以删除在指定网页（或不包含指定网页）下的用户数据（适用于cookies、cache、storage (CacheStorage, FileSystems, IndexedDB, LocalStorage, ServiceWorkers, and WebSQL) 类型的数据），可以在方法 <code>chrome.browsingData.remove()</code> 的第一个参数中设置选项 <code>origins</code> 或 <code>excludeOrigins</code></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>browsingData<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">&quot;origins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://www.example.com&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;cacheStorage&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cookies&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;fileSystems&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;indexedDB&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;localStorage&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;serviceWorkers&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;webSQL&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>由于 cookies 是基于域名的，所以删除特定网页的 cookies 时会删除该域名下的所有 cookies，例如删除 <code>https://www.example.com</code> 会删除 <code>.example.com</code> 域名下所有的 cookie。</p><h3 id="downloads" tabindex="-1"><a class="header-anchor" href="#downloads" aria-hidden="true">#</a> Downloads</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/downloads/" target="_blank" rel="noopener noreferrer"><code>chrome.downloads</code> API</a></li><li>关于 Downloads 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/downloads" target="_blank" rel="noopener noreferrer">官方示例</a>（MV2 版本）</li></ul><p>扩展程序可以对浏览器中的下载功能进行操作，通过 <code>chrome.downloads</code> API 可以启动、监控、操作和搜索下载项。</p><p>如果要使用 <code>Chrome.downloads</code> API，需要先在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中进行权限声明注册</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;downloads&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="history" tabindex="-1"><a class="header-anchor" href="#history" aria-hidden="true">#</a> History</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/history/" target="_blank" rel="noopener noreferrer"><code>chrome.history</code> API</a></li><li>关于 History 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/history" target="_blank" rel="noopener noreferrer">官方示例</a>（MV2 版本）</li></ul><p>扩展程序可以操作浏览器的历史记录。除了可以使用<a href="https://developer.chrome.com/docs/extensions/mv3/override/" target="_blank" rel="noopener noreferrer">覆写页面 Override Page</a> 的方式<strong>定制历史记录页面</strong>，还可以使用 <code>Chrome.history</code> 一些列 API 操作历史记录。</p><p>如果要使用 <code>Chrome.history</code> API，需要先在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中进行权限声明注册</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;history&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>💡 浏览的历史记录是通过<a href="https://developer.chrome.com/docs/extensions/reference/history/#transition-types" target="_blank" rel="noopener noreferrer">不同类型的页面跳转 transition type</a> 所产生的，例如用户从一个网页中点击一个链接跳转到另一个网页，这时候产生的历史记录的类型是 <code>link</code>。</p><h3 id="tabs" tabindex="-1"><a class="header-anchor" href="#tabs" aria-hidden="true">#</a> Tabs</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/tabs/" target="_blank" rel="noopener noreferrer"><code>chrome.tabs</code> API</a></li><li>关于 Tabs 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/downloads" target="_blank" rel="noopener noreferrer">官方示例</a>（MV2 版本）</li></ul><p>扩展程序可以创建、修改、重排标签页。</p><p>虽然使用 <code>Chrome.tabs</code> 部分的 API 可以不进行权限声明，但是仍<strong>推荐</strong>在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中进行权限声明注册，因为需要访问标签的属性 <code>url</code>、<code>pendingUrl</code>、<code>title</code>、<code>favIconUrl</code> 时是需要权限许可的。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;tabs&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>以下是一些常见的应用场景：</p><ul><li><p>使用方法 <code>chrome.tabs.create()</code> 在新的标签页打开一个网页</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
<span class="token comment">// 可以在安装成功后，打开扩展程序的介绍页面</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">===</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>OnInstalledReason<span class="token punctuation">.</span><span class="token constant">INSTALL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      url<span class="token operator">:</span> <span class="token string">&#39;onboarding.html&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>⚠️ 内容脚本 content scripts <strong>不</strong>能使用方法 <code>chrome.tabs.create()</code></p></li><li><p>使用方法 <code>chrome.tabs.query({ active: true, currentWindow: true })</code> 获取符合条件的标签页</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getCurrentTab</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> queryOptions <span class="token operator">=</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> currentWindow<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 查询返回的是符合条件的标签页对象列表，当前页面只有一个，可以直接用解构来获取</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>tab<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> tab<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>⚠️ 内容脚本 content scripts <strong>不</strong>能使用方法 <code>chrome.tabs.query()</code></p></li><li><p>使用方法 <code>chrome.tabs.update()</code> 更新标签页面的状态</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
<span class="token keyword">function</span> <span class="token function">toggleMuteState</span><span class="token punctuation">(</span><span class="token parameter">tabId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tabId<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取标签页的静音状态，并进行切换</span>
    <span class="token keyword">let</span> muted <span class="token operator">=</span> <span class="token operator">!</span>tab<span class="token punctuation">.</span>mutedInfo<span class="token punctuation">.</span>muted<span class="token punctuation">;</span>
    <span class="token comment">// 更新标签页的静音状态</span>
    <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>tabId<span class="token punctuation">,</span> <span class="token punctuation">{</span> muted <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Tab </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tab<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> muted <span class="token operator">?</span> <span class="token string">&#39;muted&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;unmuted&#39;</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>⚠️ 内容脚本 content scripts <strong>不</strong>能使用方法 <code>chrome.tabs.get()</code> 和 <code>chrome.tabs.update()</code></p></li><li><p>使用方法 <code>chrome.tabs.move()</code> 重排标签页</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
<span class="token comment">// 监听标签页激活事件（点击浏览器最顶部一栏进行标签页切换时触发）</span>
chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span>onActivated<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token parameter">activeInfo</span> <span class="token operator">=&gt;</span> <span class="token function">move</span><span class="token punctuation">(</span>activeInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将激活的标签页移到第一的位置</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token parameter">activeInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>activeInfo<span class="token punctuation">.</span>tabId<span class="token punctuation">,</span> <span class="token punctuation">{</span>index<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Success.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果用户在拖拽标签页时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token string">&#39;Error: Tabs cannot be edited right now (user may be dragging a tab).&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">move</span><span class="token punctuation">(</span>activeInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li></ul><h3 id="windows" tabindex="-1"><a class="header-anchor" href="#windows" aria-hidden="true">#</a> Windows</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/windows/" target="_blank" rel="noopener noreferrer"><code>chrome.windows</code> API</a></li><li>关于 Windows 的官方示例 <ul><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/windows/merge_windows" target="_blank" rel="noopener noreferrer">merge_windows</a>（MV2 版本）</li><li><a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/tabs/inspector" target="_blank" rel="noopener noreferrer">inspector</a>（MV2 版本）</li></ul></li></ul><p>扩展程序可以创建、修改、重排浏览器窗口。</p><p>由于使用 <code>Chrome.windows</code> API 时，会获取标签页的相关信息 ，所以需要先在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中进行 <code>tabs</code> 的权限声明。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;tabs&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>💡 当前窗口是指目前扩展程序执行代码所在的窗口，而不一定是浏览器的置顶窗口或当前聚焦窗口，例如扩展程序在一个窗口中打开了一个 HTML 文档，在文档中调用了 <code>chrome.tabs.query()</code> 方法，则<strong>当前窗口</strong>是指该 HTML 文档所在的窗口。有些情况下对于后台脚本没有相应的当前窗口。</p><h2 id="定制网页体验" tabindex="-1"><a class="header-anchor" href="#定制网页体验" aria-hidden="true">#</a> 定制网页体验</h2><p>扩展程序可以使用很多相关的 API 以定制网页的体验：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/mv3/manifest/activeTab/" target="_blank" rel="noopener noreferrer">Active Tab</a> 可以直接访问当前的激活标签页，而不需要先为特定的域名设置权限 <code>host_permission</code>（或使用 <code>&lt;all_urls&gt;</code> 为所有域名设置权限）</li><li><a href="https://developer.chrome.com/docs/extensions/reference/contentSettings/" target="_blank" rel="noopener noreferrer">Content Settings</a> 设置网页可以运行的功能，例如 cookies、JavaScript、plugins、camera 等许可设置 💡<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/c2437ba5364f92e8f0276f9213fdbe7ff0f4fb64/mv2-archive/api/contentSettings" target="_blank" rel="noopener noreferrer">官方示例</a>（MV2 版本）</li><li><a href="https://developer.chrome.com/docs/extensions/mv3/content_scripts/" target="_blank" rel="noopener noreferrer">Content Scripts</a> 内容脚本，植入到网页中运行的脚本</li><li><a href="https://developer.chrome.com/docs/extensions/reference/cookies/" target="_blank" rel="noopener noreferrer">Cookies</a> 获取或修改相应域名下的 cookie 💡 <a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/cookies" target="_blank" rel="noopener noreferrer">官方示例</a>（MV2 版本）</li><li><a href="https://developer.chrome.com/docs/extensions/mv3/xhr/" target="_blank" rel="noopener noreferrer">Cross-Origin XHR</a> 向远程服务器发送和接收数据</li><li><a href="https://developer.chrome.com/docs/extensions/reference/desktopCapture/" target="_blank" rel="noopener noreferrer">Desktop Capture</a> 捕获屏幕、单个窗口或标签页的内容</li><li><a href="https://developer.chrome.com/docs/extensions/reference/pageCapture/" target="_blank" rel="noopener noreferrer">Page Capture</a> 将标签页的源信息保存为 MHTML</li><li><a href="https://developer.chrome.com/docs/extensions/reference/tabCapture/" target="_blank" rel="noopener noreferrer">Tab Capture</a> 与标签页的媒体流进行交互</li><li><a href="https://developer.chrome.com/docs/extensions/reference/webNavigation/" target="_blank" rel="noopener noreferrer">Web Navigation</a> 实时更新导航请求的状态 💡 <a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/webNavigation" target="_blank" rel="noopener noreferrer">官方示例</a>（MV2 版本）</li><li><a href="https://developer.chrome.com/docs/extensions/reference/declarativeNetRequest/" target="_blank" rel="noopener noreferrer">Declarative Net Request</a> 声明规则让 Chrome 实时拦截、阻止或修改网络请求 💡 <a href="https://developer.chrome.com/docs/extensions/reference/declarativeNetRequest/#example" target="_blank" rel="noopener noreferrer">官方示例</a></li></ul><h3 id="active-tab" tabindex="-1"><a class="header-anchor" href="#active-tab" aria-hidden="true">#</a> Active Tab</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/mv3/manifest/activeTab/" target="_blank" rel="noopener noreferrer">The activeTab permission</a></li><li>关于 Windows 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/examples/page-redder" target="_blank" rel="noopener noreferrer">官方示例</a></li></ul><p>在配置清单 <code>manifest.json</code> 的选项 <code>permissions</code> 中声明 <code>activeTab</code> 权限，可以<strong>临时获取许可，以访问当前激活的标签页</strong>，并在当前页面使用 <a href="https://developer.chrome.com/docs/extensions/reference/tabs/" target="_blank" rel="noopener noreferrer">tabs 相关的 API</a>。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;activeTab&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>由于扩展程序的很多使用场景都只需临时访问当前激活的标签页，而不是针对特定的网页，所以与基于 URL 规则获取的永久访问权限相比，该类型的权限更常用。该权限基于用户的主动请求临时获取的（例如通过点击 Action 控件），而且仅限制在当前激活页面，相对而言更安全。</p><p>支持多种用户交互方式激活 <code>activeTab</code> 权限，以与当前标签页进行交互：</p><ul><li><p>通过 <a href="#Action">Action</a></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 点击浏览器工具栏上的扩展程序图标</span>
chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span>onClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取当前激活的标签页对象</span>
  <span class="token comment">// 并植入内容脚本</span>
  chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span> tabId<span class="token operator">:</span> tab<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token operator">:</span> reddenPage
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将网页背景色变为绿色</span>
<span class="token keyword">function</span> <span class="token function">reddenPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token string">&#39;green&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>通过 <a href="https://developer.chrome.com/docs/extensions/reference/contextMenus/" target="_blank" rel="noopener noreferrer">Context Menu</a></p></li><li><p>通过 <a href="#Commands">Commands</a></p></li><li><p>通过 <a href="#Omnibox">Omnibox</a></p></li></ul><p>💡 当前标签页获取权限后，当后续的导航在同源 origin 中进行则权限还生效，例如当前页面的 URL 从 <code>https://example.com</code> 切换到 <code>https://example.com/foo</code>；如果导航到其他源 origin，或关闭当前页面后，权限就需要重新获取。</p><p>💡 该权限一般用以替代在配置清单 <code>manifest.json</code> 的选项 <code>host_permissions</code> 中声明的 <code>&lt;all_urls&gt;</code> 权限，达到访问（任意 url）当前页面的效果，而且<strong>不会在安装扩展程序时弹出警告</strong>。</p><p><img src="/blog-web/assets/without-activetab.d43074e1.png" alt="without activeTab"></p><p><em>without activeTab</em></p><p><img src="/blog-web/assets/with-activetab.6d9e62d1.png" alt="with activeTab"></p><p><em>with activeTab</em></p><h3 id="content-scripts" tabindex="-1"><a class="header-anchor" href="#content-scripts" aria-hidden="true">#</a> Content Scripts</h3><p>参考：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/mv3/content_scripts/" target="_blank" rel="noopener noreferrer">Content scripts</a></li><li>关于 Windows 的<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/examples/page-redder" target="_blank" rel="noopener noreferrer">官方示例</a></li></ul><h4 id="可使用的-api" tabindex="-1"><a class="header-anchor" href="#可使用的-api" aria-hidden="true">#</a> 可使用的 API</h4><p>内容脚本 content script 是运行在页面中的 JavaScript 代码，它除了可以访问页面的 DOM 对象，还可以以通过信息传递 message passing 的方式与扩展程序进行通讯，可以将它看作是页面与扩展程序之间的桥梁角色。</p><p>除了借助扩展程序（通过 message passing 的方式）间接调用 Chrome 提供的 API，它还可以<strong>直接访问</strong>部分 API：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/reference/i18n/" target="_blank" rel="noopener noreferrer"><code>chrome.i18n</code> API</a></li><li><a href="https://developer.chrome.com/docs/extensions/reference/storage/" target="_blank" rel="noopener noreferrer"><code>chrome.storage</code> API</a></li><li>runtime API <ul><li><a href="https://developer.chrome.com/docs/extensions/reference/runtime#method-connect" target="_blank" rel="noopener noreferrer"><code>chrome.runtime.connect()</code></a> 发起（与指定的扩展程序间）建立长连接的信息通道的请求；而如果是从扩展程序发起长连接请求，则使用<a href="https://developer.chrome.com/docs/extensions/reference/tabs/#method-connect" target="_blank" rel="noopener noreferrer">方法 <code>chrome.tabs.connect()</code></a>。</li><li><a href="https://developer.chrome.com/docs/extensions/reference/runtime#method-getManifest" target="_blank" rel="noopener noreferrer"><code>chrome.runtime.getManifest()</code></a> 返回一个扩展程序的配置清单对象</li><li><a href="https://developer.chrome.com/docs/extensions/reference/runtime#method-getURL" target="_blank" rel="noopener noreferrer"><code>chrome.runtime.getURL(relatviePath)</code></a> 将相对于扩展程序的路径转换为绝对路径（基于扩展程序的安装信息）</li><li><a href="https://developer.chrome.com/docs/extensions/reference/runtime#property-id" target="_blank" rel="noopener noreferrer"><code>id</code></a> 扩展程序的唯一标识符</li><li><a href="https://developer.chrome.com/docs/extensions/reference/runtime#event-onConnect" target="_blank" rel="noopener noreferrer"><code>chrome.runtime.onConnect</code></a> 监听并响应扩展程序发起长连接的请求</li><li><a href="https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage" target="_blank" rel="noopener noreferrer"><code>chrome.runtime.onMessage</code></a> 监听单次请求信息</li><li><a href="https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage" target="_blank" rel="noopener noreferrer"><code>chrome.runtime.sendMessage</code></a> 传递单次请求信息</li></ul></li></ul><p>例如可以将扩展程序的静态资源展示在网页上</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Code for displaying &lt;extensionDir&gt;/images/myimage.png</span>

<span class="token comment">// 访问扩展程序的静态资源（图片）</span>
<span class="token keyword">var</span> imgURL <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token string">&quot;images/myimage.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将图片展示在运行着内容脚本的页面上</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;someImage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src <span class="token operator">=</span> imgURL<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="独立运行环境" tabindex="-1"><a class="header-anchor" href="#独立运行环境" aria-hidden="true">#</a> 独立运行环境</h4><p>内容脚本 content script 在一个独立的环境中执行（私有作用域），因此页面和扩展程序都<strong>无法</strong>访问内容脚本 content script 的变量，可以避免与页面或扩展程序的脚本发生冲突。</p><p>如果页面原来就有一个按钮点击的事件监听器</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mybutton<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> greeting <span class="token operator">=</span> <span class="token string">&quot;hello, &quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;mybutton&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    button<span class="token punctuation">.</span>person_name <span class="token operator">=</span> <span class="token string">&quot;Bob&quot;</span><span class="token punctuation">;</span>
    button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>greeting <span class="token operator">+</span> button<span class="token punctuation">.</span>person_name <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在内容脚本植入到页面后，设置另一个按钮点击的事件监听器</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> greeting <span class="token operator">=</span> <span class="token string">&quot;hola, &quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;mybutton&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span>person_name <span class="token operator">=</span> <span class="token string">&quot;Roberto&quot;</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>greeting <span class="token operator">+</span> button<span class="token punctuation">.</span>person_name <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>两个脚本互不冲突，所以最后点击一次按钮后，会有两次 alert 弹出。</p><p>⚠️ 虽然内容脚本 content scripts 运行在独立环境，但是它可以与网页交互的特点，很可能会被恶意程序利用，因此在内容脚本 content scripts 中请求访问外部服务器的数据时，需要<a href="https://developer.chrome.com/docs/extensions/mv3/content_scripts/#security" target="_blank" rel="noopener noreferrer">谨慎</a>，避免 <a href="https://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank" rel="noopener noreferrer">XSS 攻击</a>或<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" target="_blank" rel="noopener noreferrer">中间人攻击</a>。</p><h4 id="植入脚本" tabindex="-1"><a class="header-anchor" href="#植入脚本" aria-hidden="true">#</a> 植入脚本</h4><p>内容脚本 content script 可以通过声明的方式<strong>静态植入</strong>，或通过编程的方式<strong>动态植入</strong>：</p><ul><li><p>静态植入</p><p>在配置清单 <code>manifest.json</code> 的选项 <code>cjontent_scripts</code> 中声明的 JavaScript 脚本文件和 CSS 样式文件，会植入到<a href="https://developer.chrome.com/docs/extensions/mv3/match_patterns/" target="_blank" rel="noopener noreferrer">匹配</a>的网页。</p><ul><li>（必须）属性 <code>match</code> 是包含一系列匹配规则的数组，用以筛选匹配那些网页需要静态植入内容脚本</li><li>属性 <code>exclude_match</code> 排除匹配的网页</li><li>属性 <code>css</code> 和是包含一系列样式文件（路径）的数组，样式文件会在页面的 DOM 构建完成<strong>之前</strong>，按照数组元素的顺序依次植入</li><li>属性 <code>js</code> 是包含一系列脚本文件（路径）的数组，脚本按照数组元素的顺序依次植入</li><li>属性 <code>match_about_blank</code> 是一个布尔值，默认值为 <code>false</code>，以控制内容脚本 content script 是否植入到 <code>about:blank</code> 空页面中（当空页面与 <code>match</code> 条件之一匹配时）</li><li>属性 <code>run_at</code> 设置脚本植入的时间点，默认值是 <code>document_idle</code>，让浏览器决定在 <code>document_end</code>（DOM 树构建完成时）和 <code>window.onload</code> 事件触发之间择时植入；还可以设置为 <code>document_start</code> 或 <code>document_end</code></li><li>属性 <code>all_frames</code> 是一个布尔值，用以控制植入的脚本是否在标签页中所有的 frame 中运行，默认值是 <code>false</code>，即脚本只是植入到主框架中</li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
 <span class="token comment">// ...</span>
 <span class="token property">&quot;content_scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
     <span class="token property">&quot;matches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://*.nytimes.com/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     <span class="token property">&quot;css&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;my-styles.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     <span class="token property">&quot;js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;content-script.js&quot;</span><span class="token punctuation">]</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>💡 还有一种设置网页匹配规则的方式是属性 <code>include_globs</code> 和 <code>exclude_globs</code>，它们的<a href="https://developer.chrome.com/docs/extensions/mv3/content_scripts/#matchAndGlob" target="_blank" rel="noopener noreferrer">规则</a>更加灵活</p></li><li><p>动态植入</p><p>在后台脚本中就可以使用<a href="https://developer.chrome.com/docs/extensions/reference/scripting/" target="_blank" rel="noopener noreferrer">方法 <code>chrome.scripting.executeScript()</code></a> 为页面动态植入代码，需要在配置清单 <code>manifest.json</code> 中先声明权限</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;scripting&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>为了可以在运行时以编程的方式动态地在页面植入脚本，需要在配置清单 <code>manifest.json</code> 的选项 <code>host_permissions</code> 中获取访问相应页面的权限；或者在选项 <code>permissions</code> 中声明 <code>activeTab</code> 权限，这样就可以为当前激活页面植入脚本。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;scripting&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;activeTab&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;service_worker&quot;</span><span class="token operator">:</span> <span class="token string">&quot;background.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// content-script.js</span>
<span class="token comment">// 需要植入的代码</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token string">&#39;orange&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>action<span class="token punctuation">.</span>onClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在指定的标签页中植入指定的脚本或样式文件</span>
  chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span> tabId<span class="token operator">:</span> tab<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span>
    files<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;content-script.js&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><a href="https://developer.chrome.com/docs/extensions/reference/scripting/" target="_blank" rel="noopener noreferrer">方法 <code>chrome.scription.executeScript()</code></a> 可以接收两个参数，第一个参数是执行脚本的配置对象，第二个参数是回调函数。</p><ul><li><p>执行脚本的配置对象有多个属性：</p><ul><li><p>（必须）属性 <code>target</code> 设置植入目标对象（标签页）</p></li><li><p>属性 <code>files</code> 是一个包含脚本文件（路径）或样式文件（路径）的数组（💡 当前最多只支持一个文件）。如果植入的是 JavaScript 脚本，还支持指定<strong>需要执行的函数</strong></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> document<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> tabId <span class="token operator">=</span> <span class="token function">getTabId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>tabId<span class="token operator">:</span> tabId<span class="token punctuation">}</span><span class="token punctuation">,</span>
    func<span class="token operator">:</span> getTitle<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>⚠️ 如果植入的是函数，它并<strong>不会</strong>携带在定义处的上下文，因此函数中类似 <code>this</code> 和指向函数外部作用域的变量会失效而报错。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">getUserColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">changeBackgroundColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> color<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> tabId <span class="token operator">=</span> <span class="token function">getTabId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>tabId<span class="token operator">:</span> tabId<span class="token punctuation">}</span><span class="token punctuation">,</span>
      func<span class="token operator">:</span> changeBackgroundColor<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// result in a ReferenceError</span>
<span class="token comment">// because `color` is undefined when the function executes</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>如果希望使用函数作用域外部的变量，可以通过选项 <code>args</code> 预先声明，它会<strong>作为参数</strong>传入到函数中</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token function">getUserColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">changeBackgroundColor</span><span class="token punctuation">(</span><span class="token parameter">backgroundColor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> backgroundColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> tabId <span class="token operator">=</span> <span class="token function">getTabId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>tabId<span class="token operator">:</span> tabId<span class="token punctuation">}</span><span class="token punctuation">,</span>
    func<span class="token operator">:</span> changeBackgroundColor<span class="token punctuation">,</span>
    args<span class="token operator">:</span> <span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li><p>属性 <code>allFrames</code> 是控制注入的脚本运行在标签页里的所有 frame，默认值是 <code>false</code>，只运行在主框架中</p><p>💡 如果希望注入的脚本运行在指定的 frame 中，可以在<a href="https://developer.chrome.com/docs/extensions/reference/webNavigation/" target="_blank" rel="noopener noreferrer">设置 <code>frameIds</code> 属性</a> <code>target: { tabId: tabId, FrameIds: frameIds }</code></p></li></ul></li></ul></li><li><p>第二个参数是回调函数，它接收包含脚本执行完成后返回值的<strong>数组</strong>作为入参（有多个返回值是因为植入脚本可以在标签页的所有 frame 中都运行），其中主框架的返回值是数组的第一个元素，而其他 frame 的返回值是乱序的</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> document<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> tabId <span class="token operator">=</span> <span class="token function">getTabId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">executeScript</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>tabId<span class="token operator">:</span> tabId<span class="token punctuation">,</span> allFrames<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    func<span class="token operator">:</span> getTitle<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">injectionResults</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> frameResult <span class="token keyword">of</span> injectionResults<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Frame Title: &#39;</span> <span class="token operator">+</span> frameResult<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ul><p>💡 使用<a href="https://developer.chrome.com/docs/extensions/reference/scripting/#method-insertCSS" target="_blank" rel="noopener noreferrer">方法 <code>chrome.scriptiong.insertCSS()</code></a> 植入样式文件，除了支持以文件数组的方式，还支持<strong>字符串的形式</strong>，对于简单的样式这个方式更方便。该方法是植入样式到页面的，所以没有返回值作为回调函数的入参。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token string">&#39;body { background-color: red; }&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> tabId <span class="token operator">=</span> <span class="token function">getTabId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
chrome<span class="token punctuation">.</span>scripting<span class="token punctuation">.</span><span class="token function">insertCSS</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>tabId<span class="token operator">:</span> tabId<span class="token punctuation">}</span><span class="token punctuation">,</span>
    css<span class="token operator">:</span> css<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul><h4 id="监听网页消息" tabindex="-1"><a class="header-anchor" href="#监听网页消息" aria-hidden="true">#</a> 监听网页消息</h4><p>可以借助内容脚本 content scripts，实现普通的网页向扩展程序传递信息，使用<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" target="_blank" rel="noopener noreferrer">方法 <code>window.postMesage()</code></a> 向自身传递信息，然后在内容脚本 content scripts 中<strong>监听消息事件 <code>message</code></strong> 以捕获当前页面发送给自己的信息，然后在事件处理函数中，内容脚本 content scripts 就可以基于拦截的信息，执行相应的操作，例如与扩展程序进行交互。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// content scripts</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// We only accept messages from ourselves</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>source <span class="token operator">!=</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;FROM_PAGE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Content script received: &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- web page --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>send message<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;theButton&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;FROM_PAGE&quot;</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">&quot;Hello from the webpage!&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="cross-origin-xhr" tabindex="-1"><a class="header-anchor" href="#cross-origin-xhr" aria-hidden="true">#</a> Cross-Origin XHR</h3><p>如果希望在扩展程序访问外部服务器，由于在 MV3 版本中，后台脚本 background script 运行在 Service Workers 中，没有<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window" target="_blank" rel="noopener noreferrer">全局变量 <code>window</code></a> 对象，因此无法使用 XMLHttpRequest ，但可以使用方法 <code>fetch()</code> 发起网络请求。</p><p>由于内容脚本 content script 以植入网页的方式运行，因此它受到<a href="https://en.wikipedia.org/wiki/Same_origin_policy" target="_blank" rel="noopener noreferrer">同源策略</a>的限制。而扩展程序的后台脚本 background scripts 就不受此限制，只需要在 <code>host_permissions</code> 中声明后就可以访问相应的远程服务器；如果是通过 <code>fetch()</code> 的方式获取扩展程序内部的静态资源，则不需要声明权限。</p><p>⚠️ 在扩展程序中使用从外部服务器的返回的数据时，需要谨慎处理，应该<a href="https://developer.chrome.com/docs/extensions/mv3/xhr/#xss" target="_blank" rel="noopener noreferrer">更安全的逻辑代码 和 API</a>。</p><p>例如对于以下不安全的处理方法</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://api.example.com/data.json&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// WARNING! Might be evaluating an evil script!</span>
    <span class="token keyword">var</span> resp <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>responseText <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://api.example.com/data.json&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// WARNING! Might be injecting a malicious script!</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;resp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>应该改用更安全的方式</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://api.example.com/data.json&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// JSON.parse does not evaluate the attacker&#39;s scripts.</span>
    <span class="token keyword">var</span> resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://api.example.com/data.json&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// textContent does not let the attacker inject HTML elements.</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;resp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>⚠️ 由于内容脚本 content scripts 受到同源政策的限制，可以通过信息传递 message passing 借助扩展程序来 fetch 相应的服务器获取数据。但是这种处理方式会让恶意网页有可乘之机，它们可以伪造信息请求，而让扩展程序访问指定的服务器。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// content-script.js</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    contentScriptQuery<span class="token operator">:</span> <span class="token string">&#39;fetchUrl&#39;</span><span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token string">&#39;https://another-site.com/price-query?itemId=&#39;</span> <span class="token operator">+</span>
              <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>itemId<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token function">parsePrice</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>contentScriptQuery <span class="token operator">==</span> <span class="token string">&#39;fetchUrl&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// WARNING: SECURITY PROBLEM - a malicious web page may abuse</span>
      <span class="token comment">// the message handler to get access to arbitrary cross-origin</span>
      <span class="token comment">// resources.</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">text</span> <span class="token operator">=&gt;</span> <span class="token function">sendResponse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// Will respond asynchronously.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>该采用更安全的方式，不要通过信息传递 message passing 的方式直接传递完整的 URL，而是<strong>传递部分 query 参数</strong>，这样就可以在扩展程序中预设（限制）可以访问的域名</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// content-script.js</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    contentScriptQuery<span class="token operator">:</span> <span class="token string">&#39;queryPrice&#39;</span><span class="token punctuation">,</span>
    itemId<span class="token operator">:</span> <span class="token number">12345</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token parameter">price</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// backgound.js</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>contentScriptQuery <span class="token operator">==</span> <span class="token string">&#39;queryPrice&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">&#39;https://another-site.com/price-query?itemId=&#39;</span> <span class="token operator">+</span>
            <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>itemId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">text</span> <span class="token operator">=&gt;</span> <span class="token function">parsePrice</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">price</span> <span class="token operator">=&gt;</span> <span class="token function">sendResponse</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// Will respond asynchronously.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="定制开发调试工具" tabindex="-1"><a class="header-anchor" href="#定制开发调试工具" aria-hidden="true">#</a> 定制开发调试工具</h2><p>可以使用 <code>chrome.debugger</code> API 或 Chrome 内置的开发者工具 DevTools 进行开发调试（但两者不可混用，但用户唤起开发者工具时，）。</p><p>可以将 debugger 附加到一个或多个标签页中，以检测网络交互、调试 JavaScript、改变 DOM 和 CSS 等，具体使用方法可以查看<a href="https://developer.chrome.com/docs/extensions/reference/debugger/" target="_blank" rel="noopener noreferrer">官方文档</a>和<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/debugger" target="_blank" rel="noopener noreferrer">示例</a>（MV2 版本）。</p><p>扩展程序也可以为 Chrome 的开发者工具 DevTools 增添功能，例如添加新的 UI 面板和侧边栏，与被检查的页面交互，获取有关网络请求的信息等。这一类的扩展程序除了一般常用的构成部分以外，还需要使用另一套 DevTools 特有的 API，还有一个 <a href="https://developer.chrome.com/docs/extensions/mv3/devtools/#devtools-page" target="_blank" rel="noopener noreferrer">DevTools 页面</a>：</p><ul><li><a href="https://developer.chrome.com/docs/extensions/mv3/devtools.inspectedWindow" target="_blank" rel="noopener noreferrer"><code>chrome.devtools.inspectedWindow</code> API</a></li><li><a href="https://developer.chrome.com/docs/extensions/mv3/devtools.network" target="_blank" rel="noopener noreferrer"><code>chrome.devtools.network</code> API</a></li><li><a href="https://developer.chrome.com/docs/extensions/mv3/devtools.panels" target="_blank" rel="noopener noreferrer"><code>chrome.devtools.panels</code> API</a></li></ul><p><img src="/blog-web/assets/devtools-extension.481dd0f8.png" alt="DevTools-extension"></p><p><em>在 MV3 版本中，background page 已取消，后台脚本 background scripts 运行在 service workers 中</em></p><p>关于增添开发者工具 DevTools 功能的扩展程序的开发可以参考<a href="https://developer.chrome.com/docs/extensions/mv3/devtools/" target="_blank" rel="noopener noreferrer">官方文档</a>和<a href="https://github.com/GoogleChrome/chrome-extensions-samples/tree/main/mv2-archive/api/devtools" target="_blank" rel="noopener noreferrer">示例</a>（MV2 版本），以及一些<a href="https://developer.chrome.com/docs/extensions/mv3/devtools/#devtools-extension-examples" target="_blank" rel="noopener noreferrer">实例</a>。</p><h2 id="扩展程序发布" tabindex="-1"><a class="header-anchor" href="#扩展程序发布" aria-hidden="true">#</a> 扩展程序发布</h2><p>扩展程序主要是通过 <a href="https://chrome.google.com/webstore/category/extensions" target="_blank" rel="noopener noreferrer">Chrome 网上应用店</a>进行分发。</p><p>开发者通过 <a href="https://chrome.google.com/webstore/developer/dashboard" target="_blank" rel="noopener noreferrer">Developer Dashboard</a> 平台，将扩展程序项目打包 <code>.zip</code> 文件进行上传；然后该平台会对扩展程序进行安全审核以<a href="https://blog.chromium.org/2015/05/continuing-to-protect-chrome-users-from.html" target="_blank" rel="noopener noreferrer">保护用户</a>，审核成功后扩展程序会转换成后缀为 <code>.crx</code> 的特殊 ZIP 压缩包，再分发给用户。</p><p>💡 关于扩展程序的更新，Chrome 浏览器会定期检查已安装扩展程序的版本，如果发现新版本就会进行更新，无需用户干预。扩展程序的版本在配置清单 <code>manifest.json</code> 的选项 <code>version</code> 中设置</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  ...
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.5&quot;</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过提升数值来表示新版本</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  ...
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.5&quot;</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后将新的扩展程序项目打包为 <code>.zip</code> 文件，在 <a href="https://chrome.google.com/webstore/developer/dashboard" target="_blank" rel="noopener noreferrer">Developer Dashboard</a> 平台中找到相应扩展程序的旧版本，选择 <code>Edit</code> 上传压缩包，再点击 <code>Publish</code> 进行发布。</p><p>💡 其他扩展程序的分发方式可以参考<a href="https://developer.chrome.com/docs/extensions/mv3/external_extensions/" target="_blank" rel="noopener noreferrer">官方文档</a>。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">更新时间: </span><span class="meta-item-info">2021/9/24 下午4:09:23</span></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><div style="width:0px;" class="catalog-container absolute top-0 right-0 h-full hidden lg:block"><div class="headings-container sticky top-36" data-v-c28348e0><ul class="max-w-max m-2 pl-7 xl:pl-16 2xl:pl-20 py-4 opacity-50 hover:opacity-100 transition-all duration-300" data-v-c28348e0><!--[--><!--]--></ul></div></div><div style="display:none;" tabindex="0" class="sidebar-container fixed inset-y-0 left-0 z-20 lg:hidden opacity-10 hover:opacity-95"><div class="headings-container px-2 space-y-2 transition-all duration-300 py-20" data-v-6eed9461><!--[--><!--]--></div></div></div><footer class="bg-gray-200 p-8 grid grid-cols-1 md:grid-cols-3 gap-4 items-center"><div class="flex justify-center md:justify-start items-center"><a class="p-2 hover:bg-gray-300 rounded-md" href="https://benbinbin.github.io/" target="_blank"><img src="/blog-web/images/avatar.png" alt="avatar" class="w-10 h-10 rounded-full"></a></div><div class="text-center space-y-0.5"><p class="text-sm text-gray-600"> ©2021 <span class="author">Benbinbin</span>. All Right Reserved. </p><p class="text-xs text-center text-gray-400"> 除特殊说明外，本站的文章遵循 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" class="text-blue-400">CC-BY-SA-4.0</a> 协议 </p><p class="text-xs text-center text-gray-400"> 网站主题采用 <a href="https://github.com/Benbinbin/two-dishes-one-fish" target="_blank" class="text-blue-400">Two Dishes One Fish</a></p></div><div class="btn-container flex justify-center md:justify-end items-center space-x-0.5"><!--[--><a class="p-2 hover:bg-gray-300 rounded-md" href="mailto:benthomsonbin@gmail.com" target=""><img src="/blog-web/images/icons/email.svg" alt="email" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://github.com/Benbinbin" target="_blank"><img src="/blog-web/images/icons/github.svg" alt="github" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://juejin.cn/user/3175045314389278/posts" target="_blank"><img src="/blog-web/images/icons/juejin.svg" alt="juejin" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://dribbble.com/BinBinDesign" target="_blank"><img src="/blog-web/images/icons/dribbble.svg" alt="dribbble" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://twitter.com/Benbinbin_fun" target="_blank"><img src="/blog-web/images/icons/twitter.svg" alt="twitter" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://weibo.com/binbindesign" target="_blank"><img src="/blog-web/images/icons/weibo.svg" alt="weibo" class="w-auto h-6"></a><!--]--></div></footer></div><!--]--></div>
    <script type="module" src="/blog-web/assets/app.43fe0c63.js" defer></script>
  </body>
</html>

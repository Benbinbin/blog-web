<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/blog-web/images/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/katex.min.css"><title>Mongoose | Blog</title><meta name="description" content="A blog and knowledge management system about web.">
    <link rel="modulepreload" href="/blog-web/assets/app.43fe0c63.js"><link rel="modulepreload" href="/blog-web/assets/Mongoose.html.09819009.js"><link rel="modulepreload" href="/blog-web/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/blog-web/assets/Mongoose.html.b6916cf9.js">
    <link rel="stylesheet" href="/blog-web/assets/style.b42fd117.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="min-h-screen flex flex-col"><nav class="px-4 sm:px-8 py-2 flex justify-between items-center sticky top-0 z-30 bg-white"><div class="left flex items-center space-x-0.5"><!--[--><button class="text-gray-400 hover:bg-gray-100 catelog-btn p-2 select-none text-sm font-bold hover:text-gray-900 rounded-md lg:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path></svg></button><!--]--><a class="avatar p-2 hover:bg-gray-100 rounded-md" href="/blog-web/#"><img src="/blog-web/images/avatar.png" alt="avatar" class="w-10 h-10 rounded-full"></a></div><div class="right hidden sm:flex items-center space-x-0.5"><!--[--><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">All</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Network</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Frontend</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Backend</button><button class="text-gray-400 p-2 select-none text-sm font-bold hover:text-gray-900 hover:bg-gray-100 rounded-md">Project</button><!--]--><!--[--><button class="text-gray-900 bg-gray-100 hover:bg-gray-200 p-2 select-none text-sm font-bold hover:text-gray-900 rounded-md hidden lg:block"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path></svg></button><!--]--></div><div class="more-container sm:hidden relative"><button style="" class="p-2 select-none hover:bg-gray-100 rounded-md text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"></path></svg></button><button style="display:none;" class="p-2 select-none hover:bg-gray-100 rounded-md text-red-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"></path></svg></button><div style="display:none;" class="more-modal p-2 absolute top-10 right-0 z-10 flex flex-col space-y-2 bg-gray-100 rounded-md opacity-90"><!--[--><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">All</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Network</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Frontend</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Backend</button><button class="text-gray-400 px-4 py-2 select-none text-sm text-center font-bold hover:text-gray-900 hover:bg-gray-200 rounded-md">Project</button><!--]--></div></div></nav><div class="relative flex-grow"><div class="theme-container no-navbar no-sidebar"><!--[--><!----><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="mongoose" tabindex="-1"><a class="header-anchor" href="#mongoose" aria-hidden="true">#</a> Mongoose</h1><p>参考：🎦 <a href="https://www.youtube.com/playlist?list=PLhGp6N0DI_1QJMb63oecYZ3lLjrF4PnIs" target="_blank" rel="noopener noreferrer">MongoDB and Mongoose</a> | freeCodeCamp</p><p>MongoDB 是一种文档对象数据库，试图解决内存中的对象和持久化的存储之间的转换和映射问题。Mongoose 是基于 MongoDB 数据库进行数据存储和管理的 Node.js 模块，因此数据存储十分灵活且易于拓展，<strong>同时它结合了关系型数据库中 Shema 的概念，使得数据结构更严谨和管理</strong>，更为优雅地解决 MongoDB 在对象建模上的一系列问题。</p><h2 id="核心概念" tabindex="-1"><a class="header-anchor" href="#核心概念" aria-hidden="true">#</a> 核心概念</h2><p><img src="/blog-web/assets/20201003212725676_17716.8540834d.png" alt="Mongoose"></p><ul><li><strong>Schema 模式</strong>：类似于关系型数据库中的字段设置，<strong>描述了一类数据规范</strong>，包括这类数据可能包含的字段，并规定每个字段的数据类型等，它们是否可以为空，以及允许存储的最长和最短值等。</li><li><strong>Model 模型</strong>：从 Schema 产生的<strong>构造器</strong>，可以产生 Document 文档，通过查找、创建、删除 Document 来操作文档。</li><li><strong>Document 文档</strong>：本质上是 Model 的<strong>实例</strong>，每一条数据（对象）就是以一个 Document 实例来存储。</li></ul><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装" aria-hidden="true">#</a> 安装</h2><p>参考：</p><ul><li><a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">MongoDB</a></li><li><a href="https://www.mongodb.org.cn/" target="_blank" rel="noopener noreferrer">MongoDB 中文网</a></li><li><a href="https://mongoosejs.com/docs/guide.html" target="_blank" rel="noopener noreferrer">Mongoose Document</a></li><li><a href="http://mongoosejs.net/" target="_blank" rel="noopener noreferrer">Mongoose.js 中文网</a></li></ul><p>💡 mongoose 是一个 nodejs 模块，相当于协助 node 与 MongoDB 沟通的中间者，数据依然存储在 MongoDB Server 上，因此需要在系统中先安装 MongoDB 或使用 docker 容器的方式直接启动。 💡 也可以使用在线云数据库 <a href="https://www.mongodb.com/cloud/atlas" target="_blank" rel="noopener noreferrer">MongoDB Atlas</a>（有<a href="https://www.mongodb.com/pricing" target="_blank" rel="noopener noreferrer">免费额度</a>）。</p><p>在项目中安装 mongoose 模块</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> mongoose
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="基本用法" tabindex="-1"><a class="header-anchor" href="#基本用法" aria-hidden="true">#</a> 基本用法</h2><ol><li>导入 mongoose 模块</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mongoose&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="2"><li>连接数据库</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code># 连接到本地 MongoDB 的 nodegist 数据库
<span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&#39;mongodb://localhost/nodegist&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>💡 连接数据库是一个异步操作，返回一个状态待定 pending 的连接，可以通过监听时事件 <code>open</code> 或 <code>error</code> 来获取连接成功提醒和失败警告。只有连接成功后才可以进行数据库操作，<mark><strong>因此数据库的操作都在回调函数中</strong></mark>。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>var db = mongoose.connection;
db.on(&#39;error&#39;, console.error.bind(console, &#39;connection error:&#39;));
db.once(&#39;open&#39;, function() {
  // we&#39;re connected!
});
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>定义 schema，可以将其看作是 model 的配置对象，设置了 MongoDB 的集合 collection 存储的文档 document 应该具有的字段及其字段值的数据类型，可以使用 <code>required</code>、<code>unique</code>、<code>default</code> 限制字段或设置默认值。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> GistSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// 必添字段</span>
  type<span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 数组，元素是字符串</span>
  code<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">}</span><span class="token punctuation">,</span>
  author_id<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// 字段值需要唯一</span>
  created_at<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> Date<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span>now<span class="token punctuation">}</span>   <span class="token comment">// 默认值为当前时间</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>💡 schema 是 model 的构建（配置）模块，可以通过 schema 的组合（继承）来构建出复杂的 model。</p><ol start="4"><li>创建 model，第一个参数是 Model 的名称（Schema 创建 Model，相当于数据库中的 Collection 名称，使用单数单词，Mongoose 会自动在数据库中自动匹配/创建复数名称的 Collection），第二个参数是基于的 Schema</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> GistModel <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&#39;Gist&#39;</span><span class="token punctuation">,</span> GistSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>💡 model 是基于 Schema 定义的<strong>构造函数</strong>，实例化后可以得到文档，就是一条数据记录。</p><ol start="5"><li>使用 model 实例化创建 document，然后就可以对 document 进行操作。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> gist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GistModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&#39;test_gist&#39;</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">&#39;javascript&#39;</span><span class="token punctuation">,</span>
    code<span class="token operator">:</span> <span class="token string">&#39;console.log(&quot;hello world!&quot;);&#39;</span><span class="token punctuation">,</span>
    author_id<span class="token operator">:</span> <span class="token string">&#39;Ben&#39;</span><span class="token punctuation">,</span>
    created_at<span class="token operator">:</span> <span class="token string">&#39;123&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>💡 也可以先创建一个<strong>空的文档 document</strong>，该文档相当于一个对象 object，然后可以按照对象新增属性的方式，再添加 Schema 中预设的字段的值</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span>  gist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GistModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gist<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;test_gist&#39;</span><span class="token punctuation">;</span>
gist<span class="token punctuation">.</span>type<span class="token operator">:</span> <span class="token string">&#39;javascript&#39;</span><span class="token punctuation">;</span>
gist<span class="token punctuation">.</span>code<span class="token operator">:</span> <span class="token string">&#39;console.log(&quot;hello world!&quot;);&#39;</span><span class="token punctuation">;</span>
gist<span class="token punctuation">.</span>author_id<span class="token operator">:</span> <span class="token string">&#39;Ben&#39;</span><span class="token punctuation">;</span>
gist<span class="token punctuation">.</span>created_at<span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="常用操作" tabindex="-1"><a class="header-anchor" href="#常用操作" aria-hidden="true">#</a> 常用操作</h2><p>参考：<a href="https://mongoosejs.com/docs/api.html" target="_blank" rel="noopener noreferrer">mongoose API Docs</a></p><h3 id="存储" tabindex="-1"><a class="header-anchor" href="#存储" aria-hidden="true">#</a> 存储</h3><ul><li><code>&lt;documentName&gt;.save((error, doc) =&gt; {// do something})</code> 每个 document 会在调用他的 <code>save</code> 方法后保存到数据库。当数据库返回数据时会执行回调函数，💡 它的第一个参数是 <code>error</code></li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>doc<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><code>&lt;modelName&gt;.create(docArray, (err, data) =&gt; {})</code> 创建<strong>多个 documents</strong> 并保存到数据库的快捷方法，第一个传递的参数是一个对象数组，其中每一个元素（对象）都包含基于 schema 规定的键值对。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> peopleArray <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;Hannah&quot;</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> favoriteFoods<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;watermelon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mango&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;Igor&quot;</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">52</span><span class="token punctuation">,</span> favoriteFoods<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;vegetable soup&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

Person<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>peopleArray<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> People</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>People<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="查询" tabindex="-1"><a class="header-anchor" href="#查询" aria-hidden="true">#</a> 查询</h3><ul><li><code>&lt;modelName&gt;.find(&lt;query&gt;, (error, docs) =&gt; {// do something})</code> 查询所有符合条件的模型所对应的实例，以数组的形式返回。<strong>如果不传递查询条件 <code>&lt;query&gt;</code>，返回数据库中所有数据</strong>；如果希望获取特定的数据，可以传递 <code>&lt;query&gt;</code> 作为（可选）第一个参数</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 获取所有 name 以 &quot;fluff&quot; 开头的文档数据</span>
Kitten<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^fluff</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p><code>&lt;modelName&gt;.findOne(&lt;query&gt;, (error, doc) =&gt; {// do something})</code> 查询符合条件的模型所对应的实例的第一个。</p></li><li><p><code>&lt;modelName&gt;.findById(id, (error, doc) =&gt; {// do something})</code> <strong>MongoDB 会为每个文档创建一个字段 <code>_id</code>，可以通过该值查询文档</strong>。</p></li></ul><p>💡 由于与数据库的交互是<strong>异步</strong>的，可以使用<strong>链式</strong>调用的方式来实现复杂的查询：</p><ul><li>使用<a href="https://mongoosejs.com/docs/api/query.html#query_Query-sort" target="_blank" rel="noopener noreferrer">方法 <code>.sort()</code></a> 对查询结果进行排序，如设置为 <code>{age: &#39;asc&#39;}</code> 文档基于字段 <code>age</code> 升序 ascending 排列；如果需要降序可以将字段对应的值设置为 <code>desc</code></li><li>使用<a href="https://mongoosejs.com/docs/api/query.html#query_Query-limit" target="_blank" rel="noopener noreferrer">方法 <code>.limit(n)</code></a> 限制返回的文档数量最多为 <code>n</code></li><li>使用<a href="https://mongoosejs.com/docs/api/query.html#query_Query-select" target="_blank" rel="noopener noreferrer">方法 <code>.select()</code></a> 设置提取返回文档的指定字段，可以传入 <code>+fieldName</code> 或 <code>-fieldName</code> 参数以表示返回的数据中包含或不包含相应的字段（默认返回 <code>_id</code> 字段）</li><li>使用<a href="https://mongoosejs.com/docs/api/query.html#query_Query-exec" target="_blank" rel="noopener noreferrer">方法 <code>.exec()</code></a> 设置回调函数，它会执行查询方法，并在数据库返回响应时执行其中预设的函数</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Person<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>favoriteFoods<span class="token operator">:</span> <span class="token punctuation">{</span>$all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;Salad&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token string">&#39;asc&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;age&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="更新" tabindex="-1"><a class="header-anchor" href="#更新" aria-hidden="true">#</a> 更新</h3><p><strong>旧方法</strong>：通过 3 步实现文档更新，从数据库获取需要文档，编辑修改文档，将修改后的文档保存回数据库。👎 但该方法会形成深度嵌套。</p><ol><li>使用 <code>.find</code> 及类似方法获取文档</li><li>在回调函数中修改文档</li><li>调用 <code>.save()</code> 将修改后的文档保存回数据库中，由于文档已存在 <code>_id</code> 字段，因此会覆盖掉数据库原有相应文档。</li></ol><p><strong>新方法</strong>：使用 mongoose 提供的内置方法 <code>.findOneAndUpdate()</code> 方法更方便地实现文档的更新。</p><p>方法 <code>&lt;modelName&gt;.findOneAndUpdate(&lt;query&gt;, &lt;update_properties&gt;, &lt;options&gt;, &lt;callback&gt;)</code> 可以实现一步更新文档：</p><ul><li>通过 <code>&lt;query&gt;</code> 查询文档</li><li>在 <code>&lt;update_properties&gt;</code> 设置需要更新的字段</li><li>（可选）<code>&lt;options&gt;</code> 可以设置更新行为，如设置 <code>{new: true}</code> 返回更新后的文档</li><li><code>&lt;callback&gt;</code> 回调函数会在数据库返回响应后执行</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Person<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">&#39;Ben&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// 查询字段 name 的值为 Ben 的文档 </span>
  <span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// 更新文档字段 age 的值为 26</span>
  <span class="token punctuation">{</span><span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">// 返回修改后的值</span>
  <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>💡 也可以使用方法 <code>findByIdAndUpdate()</code> 基于的 <code>_id</code> 字段更新文档。</p><h3 id="删除" tabindex="-1"><a class="header-anchor" href="#删除" aria-hidden="true">#</a> 删除</h3><ul><li><code>&lt;modelName&gt;.findOneAndRemove(&lt;query&gt;, (error, doc) =&gt; {// do something})</code> 删除匹配的一个文档，并且被移除的文档会作为数据库响应的 <code>data</code> 参数返回。</li></ul><p>💡 也可以使用方法 <code>.findByIdAndRemove()</code> 基于 ID 删除文档。</p><ul><li><code>&lt;modelName&gt;.remove(&lt;query&gt;, (error, JSONStatus) =&gt; {// do something})</code> 删除匹配的所有文档，返回一个 JSON status 状态码。如果只想删除第一个匹配的文档，可以添加配置项 <code>{single: true}</code> 作为（可选）第二个参数。</li></ul><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">更新时间: </span><span class="meta-item-info">2021/7/6 上午2:38:22</span></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><div style="width:0px;" class="catalog-container absolute top-0 right-0 h-full hidden lg:block"><div class="headings-container sticky top-36" data-v-c28348e0><ul class="max-w-max m-2 pl-7 xl:pl-16 2xl:pl-20 py-4 opacity-50 hover:opacity-100 transition-all duration-300" data-v-c28348e0><!--[--><!--]--></ul></div></div><div style="display:none;" tabindex="0" class="sidebar-container fixed inset-y-0 left-0 z-20 lg:hidden opacity-10 hover:opacity-95"><div class="headings-container px-2 space-y-2 transition-all duration-300 py-20" data-v-6eed9461><!--[--><!--]--></div></div></div><footer class="bg-gray-200 p-8 grid grid-cols-1 md:grid-cols-3 gap-4 items-center"><div class="flex justify-center md:justify-start items-center"><a class="p-2 hover:bg-gray-300 rounded-md" href="https://benbinbin.github.io/" target="_blank"><img src="/blog-web/images/avatar.png" alt="avatar" class="w-10 h-10 rounded-full"></a></div><div class="text-center space-y-0.5"><p class="text-sm text-gray-600"> ©2021 <span class="author">Benbinbin</span>. All Right Reserved. </p><p class="text-xs text-center text-gray-400"> 除特殊说明外，本站的文章遵循 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" class="text-blue-400">CC-BY-SA-4.0</a> 协议 </p><p class="text-xs text-center text-gray-400"> 网站主题采用 <a href="https://github.com/Benbinbin/two-dishes-one-fish" target="_blank" class="text-blue-400">Two Dishes One Fish</a></p></div><div class="btn-container flex justify-center md:justify-end items-center space-x-0.5"><!--[--><a class="p-2 hover:bg-gray-300 rounded-md" href="mailto:benthomsonbin@gmail.com" target=""><img src="/blog-web/images/icons/email.svg" alt="email" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://github.com/Benbinbin" target="_blank"><img src="/blog-web/images/icons/github.svg" alt="github" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://juejin.cn/user/3175045314389278/posts" target="_blank"><img src="/blog-web/images/icons/juejin.svg" alt="juejin" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://dribbble.com/BinBinDesign" target="_blank"><img src="/blog-web/images/icons/dribbble.svg" alt="dribbble" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://twitter.com/Benbinbin_fun" target="_blank"><img src="/blog-web/images/icons/twitter.svg" alt="twitter" class="w-auto h-6"></a><a class="p-2 hover:bg-gray-300 rounded-md" href="https://weibo.com/binbindesign" target="_blank"><img src="/blog-web/images/icons/weibo.svg" alt="weibo" class="w-auto h-6"></a><!--]--></div></footer></div><!--]--></div>
    <script type="module" src="/blog-web/assets/app.43fe0c63.js" defer></script>
  </body>
</html>
